<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VERA - Your AI Co-Regulator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0a0e27;
      --bg-secondary: #151832;
      --bg-tertiary: #1a1d3a;
      --text-primary: rgba(255, 255, 255, 0.95);
      --text-secondary: rgba(255, 255, 255, 0.7);
      --text-tertiary: rgba(255, 255, 255, 0.5);
      --border: rgba(255, 255, 255, 0.08);
      --orb-1: #9B59B6;
      --orb-2: #B19CD9;
      --orb-3: #64B5F6;
      --accent: #7B9EF0;
      --hover: rgba(123, 158, 240, 0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      display: flex;
    }

    /* SIDEBAR */
    .sidebar {
      width: 280px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 100;
      transition: width 0.3s ease;
    }

    .sidebar.collapsed {
      width: 60px;
    }

    .sidebar-header {
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }

    .sidebar-header > div:first-child {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }

    /* Sidebar Logo and Top Navigation */

    .sidebar-header .trial-btn-dismiss {
      padding: 4px 8px;
      flex-shrink: 0;
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      overflow: hidden;
    }

    .vera-orb {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, var(--orb-3), var(--orb-2), var(--orb-1));
      flex-shrink: 0;
      animation: orbGlow 4s infinite;
      box-shadow: 0 0 20px rgba(155, 89, 182, 0.4);
    }

    @keyframes orbGlow {
      0%, 100% { box-shadow: 0 0 20px rgba(155, 89, 182, 0.4); }
      50% { box-shadow: 0 0 30px rgba(155, 89, 182, 0.6); }
    }

    .logo-text {
      font-size: 1.25rem;
      font-weight: 300;
      letter-spacing: 0.15em;
      white-space: nowrap;
      opacity: 1;
      transition: opacity 0.2s;
    }

    .sidebar.collapsed .logo-text {
      opacity: 0;
      width: 0;
    }

    .sidebar-toggle {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .sidebar-toggle:hover {
      background: var(--hover);
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .new-thread-btn {
      margin: 1rem;
      padding: 0.75rem 1rem;
      background: linear-gradient(135deg, var(--orb-1), var(--orb-3));
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.3s;
    }

    .new-thread-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(155, 89, 182, 0.4);
    }

    .sidebar.collapsed .new-thread-btn span:last-child {
      display: none;
    }

    .threads-section {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .threads-section::-webkit-scrollbar {
      width: 4px;
    }

    .threads-section::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }

    .thread-category {
      margin-bottom: 1.5rem;
    }

    .category-label {
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-tertiary);
    }

    .sidebar.collapsed .category-label {
      opacity: 0;
      height: 0;
      padding: 0;
      margin: 0;
    }

    .thread-item {
      padding: 0.75rem;
      margin: 0.25rem 0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      position: relative;
      overflow: hidden;
    }

    .sidebar.collapsed .thread-item {
      justify-content: center;
      padding: 0.75rem;
    }

    .thread-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 0;
      background: var(--accent);
      transition: height 0.2s;
      border-radius: 0 2px 2px 0;
    }

    .thread-item:hover {
      background: var(--hover);
    }

    .thread-item:hover::before {
      height: 70%;
    }

    .thread-item.active {
      background: var(--bg-tertiary);
    }

    .thread-item.active::before {
      height: 70%;
    }

    .thread-orb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, var(--orb-3), var(--orb-2), var(--orb-1));
      flex-shrink: 0;
      box-shadow: 0 0 12px rgba(155, 89, 182, 0.4);
      animation: orbTwinkle 3s ease-in-out infinite;
    }

    @keyframes orbTwinkle {
      0%, 100% { 
        box-shadow: 0 0 12px rgba(155, 89, 182, 0.4);
      }
      50% { 
        box-shadow: 0 0 18px rgba(155, 89, 182, 0.6);
      }
    }

    .thread-content {
      flex: 1;
      overflow: hidden;
      opacity: 1;
      transition: opacity 0.2s;
    }

    .sidebar.collapsed .thread-content {
      opacity: 0;
      width: 0;
      display: none;
    }

    .thread-title {
      font-size: 0.9rem;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 0.25rem;
    }

    .thread-preview {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Tooltip for collapsed threads */
    .sidebar.collapsed .thread-item:hover::after {
      content: attr(data-title);
      position: absolute;
      left: 100%;
      top: 50%;
      transform: translateY(-50%);
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      margin-left: 0.5rem;
      white-space: nowrap;
      font-size: 0.85rem;
      z-index: 1000;
      pointer-events: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .sidebar-footer {
      padding: 1rem;
      border-top: 1px solid var(--border);
      position: relative;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .user-profile:hover {
      background: var(--hover);
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--orb-2), var(--orb-3));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      flex-shrink: 0;
    }

    .user-info {
      flex: 1;
      overflow: hidden;
      opacity: 1;
      transition: opacity 0.2s;
    }

    .sidebar.collapsed .user-info {
      opacity: 0;
      width: 0;
      display: none;
    }

    .user-name {
      font-size: 0.9rem;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-status {
      font-size: 0.75rem;
      color: var(--text-tertiary);
    }

    /* Tooltip for collapsed user profile */
    .sidebar.collapsed .user-profile:hover::after {
      display: none;
    }

    /* Share Button */
    .share-btn {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .share-btn:hover {
      background: var(--hover);
      border-color: var(--accent);
    }

    /* Profile Menu */
    .profile-menu {
      position: fixed;
      bottom: auto;
      left: auto;
      right: auto;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0.5rem 0;
      display: none;
      flex-direction: column;
      z-index: 1000;
      max-width: 250px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.2s ease-out;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .profile-menu.active {
      display: flex;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .profile-menu-header {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
    }

    .profile-menu-email {
      font-size: 0.85rem;
      color: var(--text-secondary);
      word-break: break-all;
    }

    .profile-menu-divider {
      height: 1px;
      background: var(--border);
      margin: 0.5rem 0;
    }

    .profile-menu-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: none;
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 0.9rem;
      text-align: left;
      transition: all 0.2s;
      width: 100%;
    }

    .profile-menu-item:hover {
      background: var(--hover);
    }

    .profile-menu-icon {
      font-size: 1rem;
      min-width: 20px;
    }

    .profile-menu-arrow {
      margin-left: auto;
      color: var(--text-tertiary);
    }

    .profile-menu-logout {
      color: #ef4444;
    }

    .profile-menu-logout:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    /* MAIN CONTENT */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .top-nav {
      padding: 1rem 2rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-secondary);
      min-height: 70px;
      position: sticky;
      top: 0;
      z-index: 150;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .nav-actions {
      display: flex;
      gap: 0.75rem;
    }

    .nav-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-size: 1rem;
    }

    .nav-btn:hover {
      background: var(--hover);
      border-color: var(--accent);
      color: var(--text-primary);
    }

    /* Trial Countdown Badge */
    .trial-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, rgba(245, 166, 35, 0.15) 0%, rgba(214, 137, 16, 0.15) 100%);
      border: 1px solid rgba(245, 166, 35, 0.4);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #f5a623;
      transition: all 0.3s ease;
      cursor: pointer;
      animation: fadeIn 0.4s ease-out;
    }

    .trial-badge:hover {
      background: linear-gradient(135deg, rgba(245, 166, 35, 0.25) 0%, rgba(214, 137, 16, 0.25) 100%);
      border-color: rgba(245, 166, 35, 0.6);
      box-shadow: 0 4px 12px rgba(245, 166, 35, 0.2);
    }

    .trial-badge-icon {
      font-size: 1rem;
      animation: pulse 2s infinite;
    }

    .trial-badge-text {
      font-family: 'Monaco', 'Courier New', monospace;
      letter-spacing: 0.5px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateX(10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      overflow-y: auto;
      position: relative;
    }

    .chat-area::-webkit-scrollbar {
      width: 6px;
    }

    .chat-area::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .welcome-state {
      max-width: 800px;
      width: 100%;
      text-align: center;
      animation: fadeInUp 0.8s ease-out;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      padding: 0 1rem;
      box-sizing: border-box;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .welcome-orb {
      width: 120px;
      height: 120px;
      margin: 0 auto 2rem;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, var(--orb-3), var(--orb-2), var(--orb-1));
      animation: breatheOrb 8s ease-in-out infinite;
      box-shadow: 0 0 60px rgba(155, 89, 182, 0.5);
      position: relative;
      overflow: hidden;
    }

    .welcome-orb::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1), transparent);
      animation: breatheShimmer 8s ease-in-out infinite;
    }

    @keyframes breatheOrb {
      0% {
        transform: scale(1);
        box-shadow: 0 0 60px rgba(155, 89, 182, 0.5);
      }
      50% {
        transform: scale(1.1);
        box-shadow: 0 0 100px rgba(155, 89, 182, 0.8);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 60px rgba(155, 89, 182, 0.5);
      }
    }

    @keyframes breatheShimmer {
      0% { opacity: 0.3; }
      50% { opacity: 0.8; }
      100% { opacity: 0.3; }
    }

    .welcome-title {
      font-size: 2.5rem;
      font-weight: 300;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, var(--orb-2), var(--orb-3));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .welcome-subtitle {
      font-size: 1.1rem;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 3rem;
    }

    .search-container {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 2rem;
      background: linear-gradient(to top, var(--bg-primary) 80%, transparent);
      display: flex;
      justify-content: center;
      flex-direction: column;
      align-items: center;
      z-index: 50;
    }

    .search-wrapper {
      max-width: 800px;
      width: 100%;
    }

    .search-input-box {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all 0.3s;
    }

    .search-input-box:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(123, 158, 240, 0.3);
    }

    .search-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
      resize: none;
      min-height: 20px;
      max-height: 120px;
      overflow-y: auto;
      line-height: 1.5;
      padding: 0;
      margin: 0;
    }

    .search-input::placeholder {
      color: var(--text-tertiary);
    }

    .input-actions {
      display: flex;
      gap: 0.5rem;
    }

    .input-actions-left {
      display: flex;
      gap: 0.5rem;
      order: -1;
    }

    .new-thread-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: var(--accent);
      border: 1px solid var(--accent);
      color: white;
      font-size: 1.2rem;
      font-weight: 600;
      transition: all 0.2s;
    }

    .new-thread-icon:hover {
      background: rgba(123, 158, 240, 0.8);
      box-shadow: 0 4px 12px rgba(123, 158, 240, 0.3);
    }

    .attach-btn {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .input-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .input-btn:hover {
      background: var(--hover);
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .voice-btn {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .voice-btn:hover svg {
      stroke: var(--accent);
    }

    .voice-btn.listening {
      background: rgba(123, 158, 240, 0.1);
      border-color: var(--accent);
      animation: micPulse 1s infinite;
    }

    .voice-btn.listening svg {
      stroke: var(--accent);
      animation: micWave 0.6s ease-in-out infinite;
    }

    .tts-btn {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tts-btn:hover svg {
      stroke: var(--accent);
    }

    .tts-btn.active {
      background: rgba(123, 158, 240, 0.1);
      border-color: var(--accent);
    }

    .tts-btn.active svg {
      stroke: var(--accent);
    }

    @keyframes micPulse {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(123, 158, 240, 0.4);
      }
      50% {
        box-shadow: 0 0 0 6px rgba(123, 158, 240, 0.1);
      }
    }

    @keyframes micWave {
      0%, 100% {
        stroke-width: 2;
      }
      50% {
        stroke-width: 2.5;
      }
    }

    .send-btn {
      background: linear-gradient(135deg, var(--orb-1), var(--orb-3));
      border: none;
      color: white;
    }

    .send-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(155, 89, 182, 0.4);
    }

    .quick-actions {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .quick-action-btn {
      padding: 0.5rem 1rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 20px;
      color: var(--text-secondary);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-action-btn:hover {
      background: var(--hover);
      border-color: var(--accent);
      color: var(--text-primary);
      transform: translateY(-2px);
    }

    .messages-container {
      width: 100%;
      max-width: 800px;
      padding: 2rem 0;
      display: none;
    }

    .messages-container.active {
      display: block;
    }

    .message {
      margin-bottom: 2rem;
      animation: messageSlideIn 0.4s ease-out;
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-user {
      display: flex;
      justify-content: flex-end;
    }

    .message-bubble {
      max-width: 80%;
      padding: 1rem 1.5rem;
      border-radius: 16px;
      line-height: 1.6;
    }

    .message-user .message-bubble {
      background: linear-gradient(135deg, rgba(100, 181, 246, 0.2), rgba(123, 158, 240, 0.15));
      border: 1px solid rgba(100, 181, 246, 0.3);
    }

    .message-vera {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, var(--orb-3), var(--orb-2), var(--orb-1));
      flex-shrink: 0;
      animation: avatarPulse 3s infinite;
      box-shadow: 0 0 15px rgba(155, 89, 182, 0.3);
    }

    @keyframes avatarPulse {
      0%, 100% { box-shadow: 0 0 15px rgba(155, 89, 182, 0.3); }
      50% { box-shadow: 0 0 25px rgba(155, 89, 182, 0.5); }
    }

    .message-vera .message-bubble {
      background: linear-gradient(135deg, rgba(155, 89, 182, 0.2), rgba(177, 156, 217, 0.15));
      border: 1px solid rgba(155, 89, 182, 0.3);
    }

    .message-actions {
      display: none;
      gap: 0.5rem;
      margin-left: 0.5rem;
      align-items: center;
    }

    .message:hover .message-actions {
      display: flex;
    }

    .message-action-btn {
      width: 28px;
      height: 28px;
      padding: 0;
      border: none;
      background: rgba(123, 158, 240, 0.2);
      color: var(--text-secondary);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .message-action-btn:hover {
      background: rgba(123, 158, 240, 0.4);
      color: var(--accent);
    }

    .message-action-btn.saved {
      background: rgba(155, 89, 182, 0.3);
      color: var(--orb-2);
    }

    .typing-indicator {
      display: none;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .typing-indicator.active {
      display: flex;
    }

    .typing-dots {
      display: flex;
      gap: 0.4rem;
      padding: 1rem 1.5rem;
      background: linear-gradient(135deg, rgba(155, 89, 182, 0.2), rgba(177, 156, 217, 0.15));
      border: 1px solid rgba(155, 89, 182, 0.3);
      border-radius: 16px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--orb-1);
      animation: typingBounce 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }

    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 200;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .top-nav {
        padding: 0.75rem 1rem;
      }

      .trial-badge {
        padding: 6px 10px;
        font-size: 0.75rem;
        gap: 6px;
      }

      .trial-badge-icon {
        font-size: 0.85rem;
      }

      .search-container {
        padding: 1rem;
      }

      .welcome-title {
        font-size: 2rem;
      }

      .message-bubble {
        max-width: 90%;
      }

      .chat-area {
        padding: 1rem;
        align-items: center;
      }

      .welcome-state {
        width: 100%;
        margin: 0 auto;
      }

      .messages-container {
        width: 100%;
        margin: 0 auto;
      }

      .search-input-box {
        padding: 0.75rem 1rem;
        gap: 0.5rem;
        flex-wrap: wrap;
        min-height: auto;
      }

      .search-input {
        min-width: 150px;
      }

      .input-actions-left,
      .input-actions {
        flex-shrink: 0;
      }
    }

    .mobile-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 199;
    }

    .mobile-overlay.active {
      display: block;
    }

    @media (max-width: 768px) {
      .mobile-menu-btn {
        display: flex !important;
      }
    }

    .mobile-menu-btn {
      display: none;
    }

    /* MODALS */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 300;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 400;
    }

    .modal-close {
      background: transparent;
      border: 1px solid var(--border);
      width: 32px;
      height: 32px;
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: var(--hover);
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .modal-description {
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 1.5rem;
    }

    .modal-feature-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .feature-item {
      padding: 1rem;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .feature-item-title {
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--accent);
    }

    .feature-item-desc {
      font-size: 0.9rem;
      color: var(--text-tertiary);
    }

    /* Profile Form */
    .profile-form {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .profile-field {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .profile-field label {
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .profile-value {
      padding: 0.75rem;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      word-break: break-all;
    }

    .profile-input {
      padding: 0.75rem;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .profile-input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--hover);
    }

    .profile-btn-save {
      padding: 0.75rem 1.5rem;
      background: var(--accent);
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .profile-btn-save:hover {
      background: #6b8bda;
      transform: translateY(-2px);
    }

    .profile-btn-logout {
      padding: 0.75rem 1.5rem;
      background: #c1121f;
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .profile-btn-logout:hover {
      background: #a00e1a;
    }

    .profile-message {
      padding: 0.75rem;
      background: var(--bg-tertiary);
      border-radius: 6px;
      font-size: 0.9rem;
      text-align: center;
      display: none;
    }

    .profile-message.success {
      display: block;
      background: rgba(76, 175, 80, 0.1);
      color: #4CAF50;
      border: 1px solid #4CAF50;
    }

    .profile-message.error {
      display: block;
      background: rgba(244, 67, 54, 0.1);
      color: #f44336;
      border: 1px solid #f44336;
    }

    /* Settings Controls */
    .settings-item {
      padding: 1rem;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .settings-item-header {
      margin-bottom: 1rem;
    }

    .theme-options {
      display: flex;
      gap: 0.75rem;
    }

    .theme-btn {
      flex: 1;
      padding: 0.75rem;
      background: var(--bg-primary);
      border: 2px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    .theme-btn:hover {
      border-color: var(--accent);
      background: var(--hover);
    }

    .theme-btn.active {
      border-color: var(--accent);
      background: var(--accent);
      color: var(--bg-primary);
    }

    /* Toggle Switch */
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 28px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: var(--accent);
    }

    input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }

    .toggle-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-primary);
    }

    #notificationStatus {
      color: var(--accent);
      font-weight: 600;
    }

    /* Privacy Options */
    .privacy-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .privacy-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .privacy-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--accent);
    }

    .privacy-item label {
      cursor: pointer;
      color: var(--text-primary);
    }

    /* Subscription Plans */
    .subscription-plans {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    .plan-btn {
      flex: 1;
      padding: 1rem;
      background: var(--bg-primary);
      border: 2px solid var(--accent);
      border-radius: 8px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .plan-btn:hover {
      background: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(123, 158, 240, 0.3);
    }

    .plan-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
    }

    .plan-price {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .plan-period {
      font-size: 0.75rem;
      font-weight: 400;
      opacity: 0.8;
    }

    .plan-desc {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    /* Share Modal */
    .share-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .share-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      padding: 1.25rem 1rem;
      background: var(--bg-tertiary);
      border: 2px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    .share-btn:hover {
      border-color: var(--accent);
      background: var(--hover);
      transform: translateY(-2px);
    }

    .share-icon {
      font-size: 1.5rem;
    }

    .share-label {
      font-size: 0.875rem;
    }

    .share-message {
      text-align: center;
      padding: 1rem;
      border-radius: 6px;
      background: rgba(123, 158, 240, 0.1);
      color: var(--accent);
      font-size: 0.875rem;
      display: none;
      margin-top: 1rem;
    }

    .share-message.visible {
      display: block;
      animation: slideUp 0.3s ease;
    }

    /* Report Form */
    .report-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .report-form textarea,
    .report-form input {
      width: 100%;
      padding: 0.75rem;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9rem;
      resize: vertical;
    }

    .report-form textarea::placeholder,
    .report-form input::placeholder {
      color: var(--text-tertiary);
    }

    .submit-btn {
      padding: 0.75rem 1.5rem;
      background: var(--accent);
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .submit-btn:hover {
      background: #6a8ce0;
      transform: translateY(-2px);
    }

    .report-message {
      text-align: center;
      padding: 1rem;
      border-radius: 6px;
      background: rgba(123, 158, 240, 0.1);
      color: var(--accent);
      font-size: 0.875rem;
      display: none;
    }

    .report-message.visible {
      display: block;
      animation: slideUp 0.3s ease;
    }

    /* About Content */
    .about-content {
      line-height: 1.8;
      color: var(--text-primary);
    }

    .about-content p {
      margin-bottom: 1rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .about-content h3 {
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
      color: var(--accent);
      font-size: 1rem;
      font-weight: 600;
    }

    /* History List */
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-height: 400px;
      overflow-y: auto;
    }

    .history-item {
      padding: 1rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-item:hover {
      border-color: var(--accent);
      background: var(--hover);
      transform: translateX(4px);
    }

    .history-item-content {
      flex: 1;
    }

    .history-item-title {
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .history-item-time {
      font-size: 0.8rem;
      color: var(--text-tertiary);
    }

    .history-item-delete {
      background: none;
      border: none;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0;
      margin-left: 0.5rem;
      transition: color 0.2s;
    }

    .history-item-delete:hover {
      color: #ff6b6b;
    }

    .history-empty {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--text-tertiary);
      font-size: 0.9rem;
    }

    /* Light Theme */
    html.light-theme {
      --bg-primary: #f5f5f5;
      --bg-secondary: #ffffff;
      --bg-tertiary: #efefef;
      --text-primary: rgba(0, 0, 0, 0.95);
      --text-secondary: rgba(0, 0, 0, 0.7);
      --text-tertiary: rgba(0, 0, 0, 0.5);
      --border: rgba(0, 0, 0, 0.08);
    }

    /* Rose/Coral Theme */
    html.rose-theme {
      --bg-primary: #1a0f1a;
      --bg-secondary: #2a1428;
      --bg-tertiary: #3a1f38;
      --text-primary: rgba(255, 255, 255, 0.95);
      --text-secondary: rgba(255, 255, 255, 0.7);
      --text-tertiary: rgba(255, 255, 255, 0.5);
      --border: rgba(255, 182, 193, 0.15);
      --orb-1: #E91E63;
      --orb-2: #F48FB1;
      --orb-3: #FFB6D9;
      --accent: #FF69B4;
      --hover: rgba(255, 105, 180, 0.1);
    }

    /* BREATHING SESSION */
    .breathing-session {
      display: none;
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, rgba(10, 14, 39, 0.95), rgba(21, 24, 50, 0.95));
      z-index: 400;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .breathing-session.active {
      display: flex;
    }

    .breathing-close {
      position: absolute;
      top: 2rem;
      right: 2rem;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      transition: all 0.2s;
    }

    .breathing-close:hover {
      background: var(--hover);
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .breathing-container {
      text-align: center;
      max-width: 600px;
    }

    .breathing-title {
      font-size: 2rem;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, var(--orb-2), var(--orb-3));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .breathing-instruction {
      font-size: 1.2rem;
      color: var(--text-secondary);
      margin-bottom: 3rem;
      min-height: 30px;
    }

    .breathing-orb-container {
      position: relative;
      width: 250px;
      height: 250px;
      margin: 0 auto 3rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .breathing-orb-visual {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, var(--orb-3), var(--orb-2), var(--orb-1));
      box-shadow: 0 0 100px rgba(155, 89, 182, 0.6);
      animation: breatheInhale 4s ease-in-out infinite;
    }

    .breathing-orb-visual.exhale {
      animation: breatheExhale 6s ease-in-out infinite;
    }

    @keyframes breatheInhale {
      0% {
        transform: scale(0.8);
        box-shadow: 0 0 60px rgba(155, 89, 182, 0.4);
      }
      100% {
        transform: scale(1.3);
        box-shadow: 0 0 120px rgba(155, 89, 182, 0.8);
      }
    }

    @keyframes breatheExhale {
      0% {
        transform: scale(1.3);
        box-shadow: 0 0 120px rgba(155, 89, 182, 0.8);
      }
      100% {
        transform: scale(0.8);
        box-shadow: 0 0 60px rgba(155, 89, 182, 0.4);
      }
    }

    .breathing-counter {
      font-size: 1.1rem;
      color: var(--text-secondary);
      margin-top: 2rem;
      padding: 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-tertiary);
    }

    .breathing-counter-number {
      font-size: 1.8rem;
      color: var(--accent);
      font-weight: 500;
    }

    .breathing-stats {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-top: 2rem;
      padding: 1.5rem;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .breathing-stat {
      text-align: center;
    }

    .breathing-stat-label {
      font-size: 0.9rem;
      color: var(--text-tertiary);
      margin-bottom: 0.5rem;
    }

    .breathing-stat-value {
      font-size: 1.5rem;
      color: var(--accent);
      font-weight: 500;
    }

    .breathing-controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
    }

    .breathing-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s;
    }

    .breathing-btn-primary {
      background: linear-gradient(135deg, var(--orb-1), var(--orb-3));
      color: white;
      font-weight: 500;
    }

    .breathing-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(155, 89, 182, 0.4);
    }

    .breathing-btn-secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .breathing-btn-secondary:hover {
      background: var(--hover);
      border-color: var(--accent);
      color: var(--text-primary);
    }

    /* GROUNDING SESSION */
    .grounding-session {
      display: none;
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, rgba(10, 14, 39, 0.95), rgba(21, 24, 50, 0.95));
      z-index: 400;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      overflow-y: auto;
    }

    .grounding-session.active {
      display: flex;
    }

    .grounding-close {
      position: absolute;
      top: 2rem;
      right: 2rem;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      transition: all 0.2s;
    }

    .grounding-close:hover {
      background: var(--hover);
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .grounding-container {
      text-align: center;
      max-width: 600px;
    }

    .grounding-title {
      font-size: 2rem;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, var(--orb-2), var(--orb-3));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .grounding-subtitle {
      font-size: 1rem;
      color: var(--text-tertiary);
      margin-bottom: 2rem;
    }

    .grounding-step {
      padding: 1.5rem;
      background: var(--bg-tertiary);
      border: 2px solid transparent;
      border-radius: 12px;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
    }

    .grounding-step:hover {
      border-color: var(--accent);
      background: rgba(123, 158, 240, 0.1);
    }

    .grounding-step.active {
      border-color: var(--accent);
      background: rgba(123, 158, 240, 0.2);
    }

    .grounding-step-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .grounding-step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--orb-1), var(--orb-3));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: white;
      flex-shrink: 0;
    }

    .grounding-step-title {
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .grounding-step-content {
      font-size: 0.95rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .grounding-input {
      width: 100%;
      padding: 0.75rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.95rem;
      margin-top: 0.5rem;
      font-family: inherit;
    }

    .grounding-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(123, 158, 240, 0.3);
    }

    .grounding-progress {
      width: 100%;
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      margin: 2rem 0;
      overflow: hidden;
    }

    .grounding-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--orb-1), var(--orb-3));
      width: 0%;
      transition: width 0.5s ease;
    }

    .grounding-controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
    }

    .grounding-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s;
    }

    .grounding-btn-primary {
      background: linear-gradient(135deg, var(--orb-1), var(--orb-3));
      color: white;
      font-weight: 500;
    }

    .grounding-btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(155, 89, 182, 0.4);
    }

    .grounding-btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .grounding-btn-secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .grounding-btn-secondary:hover {
      background: var(--hover);
      border-color: var(--accent);
      color: var(--text-primary);
    }

    /* TTS Toast Notification */
    .tts-discovery-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      display: flex;
      gap: 12px;
      align-items: center;
      z-index: 10000;
      animation: slideIn 0.3s ease-out;
      max-width: 320px;
    }

    .toast-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .toast-content {
      flex: 1;
      min-width: 0;
    }

    .toast-content strong {
      display: block;
      font-size: 0.95rem;
      margin-bottom: 2px;
    }

    .toast-content p {
      font-size: 0.85rem;
      opacity: 0.9;
      margin: 0;
    }

    .toast-btn-dismiss {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      margin: 0 -8px 0 0;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .toast-btn-dismiss:hover {
      opacity: 1;
    }

    .toast-btn-primary {
      background: rgba(255, 255, 255, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.5);
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: background 0.2s;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .toast-btn-primary:hover {
      background: rgba(255, 255, 255, 0.35);
    }

    /* Compact Trial Notification Toast */
    .trial-toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #f5a623 0%, #d68910 100%);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
      z-index: 10000;
      animation: slideIn 0.3s ease-out;
      max-width: 90vw;
      width: 420px;
    }

    .trial-toast-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .trial-clock {
      font-size: 20px;
      flex-shrink: 0;
      animation: pulse 1s infinite;
    }

    .trial-text {
      flex: 1;
      min-width: 0;
    }

    .trial-text strong {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .trial-text p {
      font-size: 0.8rem;
      opacity: 0.95;
      margin: 0;
    }

    .trial-toast-btn {
      background: rgba(255, 255, 255, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.5);
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      transition: all 0.2s;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .trial-toast-btn:hover {
      background: rgba(255, 255, 255, 0.4);
      transform: scale(1.05);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* TTS Active Indicator */
    .tts-active-indicator {
      display: none;
      align-items: center;
      gap: 8px;
      margin-left: 16px;
      padding: 6px 12px;
      background: rgba(102, 126, 234, 0.2);
      border: 1px solid #667eea;
      border-radius: 20px;
      font-size: 0.85rem;
      color: #667eea;
      animation: fadeIn 0.2s;
    }

    .speaker-icon {
      font-size: 16px;
    }

    .speaking-text {
      font-weight: 500;
    }

    .sound-waves {
      display: flex;
      gap: 3px;
    }

    .wave {
      width: 3px;
      height: 12px;
      background: #667eea;
      border-radius: 2px;
      animation: waveAnimation 0.6s infinite;
    }

    .wave:nth-child(2) {
      animation-delay: 0.1s;
    }

    .wave:nth-child(3) {
      animation-delay: 0.2s;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes waveAnimation {
      0%, 100% { height: 4px; }
      50% { height: 12px; }
    }

    /* TRIAL BANNER */
    /* TRIAL UPGRADE MODAL */
    .trial-upgrade-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    .trial-upgrade-modal-content {
      position: relative;
      z-index: 2001;
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      border: 1px solid var(--border);
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .trial-upgrade-modal-content h2 {
      color: var(--text-primary);
      font-size: 1.5rem;
      margin-bottom: 8px;
    }

    .modal-subtitle {
      color: var(--text-secondary);
      margin-bottom: 24px;
      font-size: 0.95rem;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: var(--text-primary);
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-group small {
      display: block;
      color: var(--text-tertiary);
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .trial-plans {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 24px 0;
    }

    .plan-card {
      padding: 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .plan-card:hover {
      border-color: var(--accent);
      background: rgba(123, 158, 240, 0.05);
    }

    .plan-card.selected {
      border-color: var(--accent);
      background: rgba(123, 158, 240, 0.1);
    }

    .plan-card h3 {
      color: var(--text-primary);
      font-size: 0.95rem;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .plan-card .price {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .plan-card .price span {
      font-size: 0.8rem;
      opacity: 0.7;
      font-weight: 400;
    }

    .plan-card .plan-desc {
      color: var(--text-tertiary);
      font-size: 0.85rem;
      margin: 0;
    }

    .btn-submit {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 20px;
    }

    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }

    .terms-text {
      color: var(--text-tertiary);
      font-size: 0.8rem;
      text-align: center;
      margin-top: 12px;
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 24px;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      opacity: 1;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .trial-banner-content {
        flex-wrap: wrap;
        gap: 12px;
      }

      .trial-banner-middle {
        order: 1;
        width: 100%;
      }

      .trial-banner-left {
        order: 2;
      }

      .trial-banner-right {
        order: 3;
        width: 100%;
      }

      .trial-btn-upgrade {
        flex: 1;
        padding: 10px 12px;
      }

      .trial-upgrade-modal-content {
        padding: 24px;
        max-width: 90vw;
      }

      .trial-plans {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

  <!-- MODALS -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Settings</h2>
        <button class="modal-close" onclick="closeModal('settingsModal')">×</button>
      </div>
      <div class="modal-description">
        Customize your VERA experience
      </div>
      <div class="modal-feature-list">
        <!-- Theme Setting -->
        <div class="settings-item">
          <div class="settings-item-header">
            <div class="feature-item-title">Theme</div>
            <div class="feature-item-desc">Choose your preferred color mode</div>
          </div>
          <div class="theme-options">
            <button class="theme-btn active" id="themeLight" onclick="setTheme('light')">☀️ Light</button>
            <button class="theme-btn" id="themeDark" onclick="setTheme('dark')">🌙 Dark</button>
            <button class="theme-btn" id="themeRose" onclick="setTheme('rose')">💗 Rose</button>
          </div>
        </div>

        <!-- Notifications Setting -->
        <div class="settings-item">
          <div class="settings-item-header">
            <div class="feature-item-title">Notifications</div>
            <div class="feature-item-desc">Get reminders for check-ins and breathing sessions</div>
          </div>
          <div class="toggle-container">
            <label class="toggle-switch">
              <input type="checkbox" id="notificationsToggle" checked onchange="toggleNotifications()">
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Notifications <span id="notificationStatus">ON</span></span>
          </div>
        </div>

        <!-- Privacy Setting -->
        <div class="settings-item">
          <div class="settings-item-header">
            <div class="feature-item-title">Privacy</div>
            <div class="feature-item-desc">Your conversations are encrypted and never shared</div>
          </div>
          <div class="privacy-options">
            <div class="privacy-item">
              <input type="checkbox" id="encryptionToggle" checked>
              <label for="encryptionToggle">End-to-end encryption</label>
            </div>
            <div class="privacy-item">
              <input type="checkbox" id="analyticsToggle">
              <label for="analyticsToggle">Allow anonymous analytics</label>
            </div>
          </div>
        </div>

        <!-- Audio & Voice Setting -->
        <div class="settings-item">
          <div class="settings-item-header">
            <div class="feature-item-title">🎵 Audio & Voice</div>
            <div class="feature-item-desc">Enable or disable VERA's voice responses</div>
          </div>
          
          <!-- TTS Toggle - SIMPLE ON/OFF -->
          <div class="toggle-container">
            <label class="toggle-switch">
              <input type="checkbox" id="ttsEnabled" checked onchange="toggleTTS()">
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Voice Responses <span id="ttsStatus">ON</span></span>
          </div>
        </div>

        <!-- Subscription Setting -->
        <div class="settings-item">
          <div class="settings-item-header">
            <div class="feature-item-title">💳 Upgrade to Pro</div>
            <div class="feature-item-desc">Unlock premium features with a subscription</div>
          </div>
          
          <!-- Subscription Plans -->
          <div class="subscription-plans">
            <button class="plan-btn" onclick="goToCheckout('monthly')">
              <div class="plan-name">Monthly Plan</div>
              <div class="plan-price">$12<span class="plan-period">/month</span></div>
              <div class="plan-desc">Cancel anytime</div>
            </button>
            <button class="plan-btn" onclick="goToCheckout('annual')">
              <div class="plan-name">Annual Plan</div>
              <div class="plan-price">$99<span class="plan-period">/year</span></div>
              <div class="plan-desc">Save 17% vs monthly</div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="shareModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Share Session</h2>
        <button class="modal-close" onclick="closeModal('shareModal')">×</button>
      </div>
      <div class="modal-description">
        Share this conversation with others or save it for later
      </div>
      <div class="share-options">
        <button class="share-btn" onclick="copySessionLink()">
          <span class="share-icon">🔗</span>
          <span class="share-label">Copy Link</span>
        </button>
        <button class="share-btn" onclick="copyConversation()">
          <span class="share-icon">📋</span>
          <span class="share-label">Copy Text</span>
        </button>
        <button class="share-btn" onclick="shareViaEmail()">
          <span class="share-icon">📧</span>
          <span class="share-label">Email</span>
        </button>
      </div>
      <div id="shareMessage" class="share-message"></div>
    </div>
  </div>

  <div class="modal" id="reportModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Report Issue</h2>
        <button class="modal-close" onclick="closeModal('reportModal')">×</button>
      </div>
      <div class="modal-description">
        Help us improve VERA by reporting any issues
      </div>
      <div class="report-form">
        <textarea id="issueDescription" placeholder="Describe the issue you encountered..." rows="5"></textarea>
        <input type="email" id="issueEmail" placeholder="Your email (optional)">
        <button class="submit-btn" onclick="submitIssueReport()">Send Report</button>
      </div>
      <div id="reportMessage" class="report-message"></div>
    </div>
  </div>

  <div class="modal" id="aboutModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">About VERA</h2>
        <button class="modal-close" onclick="closeModal('aboutModal')">×</button>
      </div>
      <div class="about-content">
        <p><strong>VERA v1.0</strong></p>
        <p>Your AI nervous system companion for emotional regulation, self-awareness, and healing.</p>
        
        <h3>Terms of Service</h3>
        <p>VERA is designed to support your wellbeing but is not a replacement for professional mental health care. Always consult a licensed therapist or healthcare provider for serious mental health concerns.</p>
        
        <h3>Disclaimer</h3>
        <p>Your conversations are your own. We collect minimal data and never sell personal information. All sessions are encrypted and private. VERA uses AI and may occasionally produce unexpected responses - use your own judgment.</p>
        
        <h3>Privacy</h3>
        <p>We respect your privacy. Your data belongs to you. You can export or delete your data at any time using the More Options menu.</p>
      </div>
    </div>
  </div>

  <div class="modal" id="historyModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Conversation History</h2>
        <button class="modal-close" onclick="closeModal('historyModal')">×</button>
      </div>
      <div class="modal-description">
        Quick access to your recent conversations
      </div>
      <div class="history-list" id="historyList">
        <!-- Populated dynamically -->
      </div>
    </div>
  </div>

  <div class="modal" id="moreModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">More Options</h2>
        <button class="modal-close" onclick="closeModal('moreModal')">×</button>
      </div>
      <div class="modal-feature-list">
        <div class="feature-item" onclick="openHistory()">
          <div class="feature-item-title">History</div>
          <div class="feature-item-desc">Quick access to conversation history</div>
        </div>
        <div class="feature-item" onclick="exportConversation()">
          <div class="feature-item-title">Export Conversation</div>
          <div class="feature-item-desc">Download your conversation history as a PDF for your records</div>
        </div>
        <div class="feature-item" onclick="openReportIssue()">
          <div class="feature-item-title">Report Issue</div>
          <div class="feature-item-desc">Let us know if something isn't working properly</div>
        </div>
        <div class="feature-item" onclick="openAboutVERA()">
          <div class="feature-item-title">About VERA</div>
          <div class="feature-item-desc">Version 1.0 - Terms & Disclaimer</div>
        </div>
      </div>
    </div>
  </div>

  <!-- PROFILE MODAL -->
  <div class="modal" id="profileModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">👤 My Profile</h2>
        <button class="modal-close" onclick="closeModal('profileModal')">×</button>
      </div>
      <div class="profile-form">
        <!-- Email -->
        <div class="profile-field">
          <label>Email</label>
          <div class="profile-value" id="profileEmail">—</div>
        </div>

        <!-- Phone -->
        <div class="profile-field">
          <label>Phone Number</label>
          <input type="tel" id="profilePhone" placeholder="Enter your phone number" class="profile-input">
          <button class="profile-btn-save" onclick="updateProfilePhone()">Save Phone</button>
        </div>

        <!-- Subscription Status -->
        <div class="profile-field">
          <label>Subscription Status</label>
          <div class="profile-value" id="subscriptionStatus">—</div>
        </div>

        <!-- Trial/Expiry Info -->
        <div class="profile-field" id="trialInfoField" style="display: none;">
          <label>Trial Ends</label>
          <div class="profile-value" id="trialEndDate">—</div>
        </div>

        <div class="profile-field" id="subscriptionInfoField" style="display: none;">
          <label>Subscription Renews</label>
          <div class="profile-value" id="subscriptionEndDate">—</div>
        </div>

        <!-- Message -->
        <div id="profileMessage" class="profile-message"></div>

        <!-- Logout -->
        <button class="profile-btn-logout" onclick="logoutUser()">Logout</button>
      </div>
    </div>
  </div>

  <!-- BREATHING SESSION -->
  <div class="breathing-session" id="breathingSession">
    <button class="breathing-close" onclick="closBreathingSession()">×</button>
    
    <div class="breathing-container">
      <h2 class="breathing-title">Guided Breathing</h2>
      <p class="breathing-instruction" id="breathingInstruction">Get ready...</p>
      
      <div class="breathing-orb-container">
        <div class="breathing-orb-visual" id="breathingOrb"></div>
      </div>
      
      <div class="breathing-counter">
        Round <span class="breathing-counter-number" id="breathingRound">1</span> / 5
      </div>
      
      <div class="breathing-stats">
        <div class="breathing-stat">
          <div class="breathing-stat-label">Breaths</div>
          <div class="breathing-stat-value" id="breathCount">0</div>
        </div>
        <div class="breathing-stat">
          <div class="breathing-stat-label">Duration</div>
          <div class="breathing-stat-value" id="breathTime">0s</div>
        </div>
      </div>
      
      <div class="breathing-controls" id="breathingControls">
        <button class="breathing-btn breathing-btn-primary" onclick="startBreathingSession()">Start Session</button>
        <button class="breathing-btn breathing-btn-secondary" onclick="closeBreathingSession()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- GROUNDING SESSION -->
  <div class="grounding-session" id="groundingSession">
    <button class="grounding-close" onclick="closeGroundingSession()">×</button>
    
    <div class="grounding-container">
      <h2 class="grounding-title">5-4-3-2-1 Grounding</h2>
      <p class="grounding-subtitle">Notice what's real around you right now</p>
      
      <div class="grounding-progress">
        <div class="grounding-progress-bar" id="groundingProgressBar"></div>
      </div>
      
      <div id="groundingSteps">
        <div class="grounding-step active" id="step1">
          <div class="grounding-step-header">
            <div class="grounding-step-number">5</div>
            <div class="grounding-step-title">What do you SEE?</div>
          </div>
          <div class="grounding-step-content">
            Notice 5 things you can see around you. They don't need to be special - just notice them.
          </div>
          <input type="text" class="grounding-input" id="seeInput" placeholder="e.g., wall, light, tree...">
        </div>

        <div class="grounding-step" id="step2">
          <div class="grounding-step-header">
            <div class="grounding-step-number">4</div>
            <div class="grounding-step-title">What do you FEEL?</div>
          </div>
          <div class="grounding-step-content">
            Notice 4 things you can physically feel. The chair beneath you, temperature, texture...
          </div>
          <input type="text" class="grounding-input" id="feelInput" placeholder="e.g., chair, warmth, softness...">
        </div>

        <div class="grounding-step" id="step3">
          <div class="grounding-step-header">
            <div class="grounding-step-number">3</div>
            <div class="grounding-step-title">What do you HEAR?</div>
          </div>
          <div class="grounding-step-content">
            Notice 3 things you can hear. Close your eyes if it helps.
          </div>
          <input type="text" class="grounding-input" id="hearInput" placeholder="e.g., traffic, birds, quiet...">
        </div>

        <div class="grounding-step" id="step4">
          <div class="grounding-step-header">
            <div class="grounding-step-number">2</div>
            <div class="grounding-step-title">What do you SMELL?</div>
          </div>
          <div class="grounding-step-content">
            Notice 2 things you can smell. Even if it's "nothing in particular", notice that.
          </div>
          <input type="text" class="grounding-input" id="smellInput" placeholder="e.g., coffee, air...">
        </div>

        <div class="grounding-step" id="step5">
          <div class="grounding-step-header">
            <div class="grounding-step-number">1</div>
            <div class="grounding-step-title">What do you TASTE?</div>
          </div>
          <div class="grounding-step-content">
            Notice 1 thing you can taste. Or focus on the neutral sensation in your mouth.
          </div>
          <input type="text" class="grounding-input" id="tasteInput" placeholder="e.g., mint, neutral...">
        </div>
      </div>
      
      <div class="grounding-controls">
        <button class="grounding-btn grounding-btn-primary" id="nextBtn" onclick="nextGroundingStep()">Next</button>
        <button class="grounding-btn grounding-btn-secondary" onclick="closeGroundingSession()">End</button>
      </div>
    </div>
  </div>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-header-top">
        <div class="logo-area">
          <div class="logo-text">VERA</div>
        </div>
        <button class="sidebar-toggle" onclick="toggleSidebar()">◀</button>
      </div>
      
      <!-- Trial Banner in Sidebar -->
    </div>

    <button class="new-thread-btn" onclick="newThread()">
      <span>+</span>
      <span>New</span>
    </button>

    <div class="threads-section" id="threadsSection">
      <div class="thread-category">
        <div class="category-label">Today</div>
        <div class="thread-item active" onclick="loadThread(1)">
          <div class="thread-content">
            <div class="thread-title">Morning check-in</div>
            <div class="thread-preview">Feeling present...</div>
          </div>
        </div>
        <div class="thread-item" onclick="loadThread(2)">
          <div class="thread-content">
            <div class="thread-title">Breathing session</div>
            <div class="thread-preview">5-minute practice</div>
          </div>
        </div>
        <div class="thread-item" onclick="loadThread(3)">
          <div class="thread-content">
            <div class="thread-title">Grounding</div>
            <div class="thread-preview">5-4-3-2-1 senses...</div>
          </div>
        </div>
        <div class="thread-item" onclick="loadThread(4)">
          <div class="thread-content">
            <div class="thread-title">Journaling prompts</div>
            <div class="thread-preview">Guided reflection...</div>
          </div>
        </div>
      </div>

      <div class="thread-category">
        <div class="category-label">This Week</div>
        <div class="thread-item" onclick="loadThread(5)">
          <div class="thread-content">
            <div class="thread-title">Pattern recognition</div>
            <div class="thread-preview">Noticing triggers...</div>
          </div>
        </div>
        <div class="thread-item" onclick="loadThread(6)">
          <div class="thread-content">
            <div class="thread-title">Processing emotions</div>
            <div class="thread-preview">Difficult conversation</div>
          </div>
        </div>
        <div class="thread-item" onclick="loadThread(7)">
          <div class="thread-content">
            <div class="thread-title">Decoding</div>
            <div class="thread-preview">Understanding messages...</div>
          </div>
        </div>
      </div>

      <div class="thread-category">
        <div class="category-label">Saved Messages</div>
        <div id="savedMessagesContainer">
          <div class="thread-item" style="padding: 0.75rem; text-align: center; color: var(--text-tertiary); font-size: 0.85rem;">
            No saved messages yet
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar-footer">
      <button class="share-btn" title="Share" onclick="shareThread()">↗</button>
      <div class="user-profile" onclick="toggleProfileMenu()">
        <div class="user-avatar" id="userAvatarInitial">J</div>
        <div class="user-info">
          <div class="user-name" id="userNameDisplay">Journey</div>
          <div class="user-status">Active</div>
        </div>
      </div>
      
      <!-- Profile Dropdown Menu -->
      <div class="profile-menu" id="profileMenu">
        <div class="profile-menu-header">
          <div class="profile-menu-email" id="profileMenuEmail">—</div>
        </div>
        <div class="profile-menu-divider"></div>
        <button class="profile-menu-item" onclick="openUpgradePlan()">
          <span class="profile-menu-icon">⬆</span>
          <span>Upgrade plan</span>
        </button>
        <button class="profile-menu-item" onclick="openOrders()">
          <span class="profile-menu-icon">📦</span>
          <span>Orders</span>
        </button>
        <button class="profile-menu-item" onclick="openPersonalization()">
          <span class="profile-menu-icon">⚙</span>
          <span>Personalization</span>
        </button>
        <button class="profile-menu-item" onclick="openSettings()">
          <span class="profile-menu-icon">🔧</span>
          <span>Settings</span>
        </button>
        <button class="profile-menu-item" onclick="openHelp()">
          <span class="profile-menu-icon">❓</span>
          <span>Help</span>
          <span class="profile-menu-arrow">›</span>
        </button>
        <div class="profile-menu-divider"></div>
        <button class="profile-menu-item profile-menu-logout" onclick="logoutUser()">
          <span class="profile-menu-icon">🚪</span>
          <span>Log out</span>
        </button>
      </div>
    </div>
  </aside>

  <main class="main-content">
    <nav class="top-nav">
      <div class="breadcrumb">
        <button class="nav-btn mobile-menu-btn" onclick="toggleSidebar()">☰</button>
      </div>
      <div class="trial-badge" id="trialBadge" style="display: none;" onclick="openCheckout()">
        <span class="trial-badge-icon">⏱️</span>
        <span class="trial-badge-text" id="trialBadgeText">13h 00m</span>
      </div>
    </nav>

    <div class="chat-area" id="chatArea">
      <!-- Trial Upgrade Modal -->
      <div class="trial-upgrade-modal" id="trialUpgradeModal" style="display: none;">
        <div class="modal-overlay" onclick="closeTrialUpgradeModal()"></div>
        <div class="modal-content trial-upgrade-modal-content">
          <button class="modal-close" onclick="closeTrialUpgradeModal()">✕</button>
          <h2>Complete Your Profile</h2>
          <p class="modal-subtitle">Continue your VERA journey with just a few details</p>
          
          <form id="trialUpgradeForm" onsubmit="handleTrialProfileSubmit(event)">
            <div class="form-group">
              <label for="trialEmail">Email Address</label>
              <input type="email" id="trialEmail" placeholder="your@email.com" required>
            </div>
            
            <div class="form-group">
              <label for="trialPhone">Phone Number</label>
              <input type="tel" id="trialPhone" placeholder="(555) 123-4567" required>
              <small>We use this to prevent duplicate accounts</small>
            </div>
            
            <div class="trial-plans">
              <div class="plan-card selected" onclick="selectPlan(this, 'monthly')">
                <h3>Monthly Plan</h3>
                <div class="price">$12<span>/month</span></div>
                <p class="plan-desc">Cancel anytime</p>
              </div>
              <div class="plan-card" onclick="selectPlan(this, 'annual')">
                <h3>Annual Plan</h3>
                <div class="price">$99<span>/year</span></div>
                <p class="plan-desc">Save 32%</p>
              </div>
            </div>
            
            <button type="submit" class="btn-submit">Continue to Payment</button>
            <p class="terms-text">By upgrading, you agree to our Terms of Service</p>
          </form>
        </div>
      </div>

      <div class="welcome-state" id="welcomeState">
        <div class="welcome-orb"></div>
        <h1 class="welcome-title">I'm VERA</h1>
        <p class="welcome-subtitle">
          Your nervous system co-regulator. A space where you're understood, never judged.
        </p>
      </div>

      <div class="messages-container" id="messagesContainer"></div>

      <div class="typing-indicator" id="typingIndicator">
        <div class="message-avatar"></div>
        <div class="typing-dots">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>
    </div>

    <div class="search-container">
      <div class="search-wrapper">
        <div class="search-input-box">
          <div class="input-actions-left">
            <button class="input-btn new-thread-icon" title="New Thread" onclick="newThread()">+</button>
            <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload(event)" accept="image/*,.pdf,.txt,.doc,.docx">
            <button class="input-btn attach-btn" title="Attach" onclick="document.getElementById('fileInput').click()">📎</button>
          </div>
          <textarea 
            class="search-input" 
            placeholder="What's present in your body right now..."
            id="messageInput"
            onkeypress="handleKeyPress(event)"
            oninput="autoResizeInput()"
            rows="1"
          ></textarea>
          <div class="input-actions">
            <button class="input-btn voice-btn" title="Voice Input (STT)" id="voiceBtn" onclick="startVoice()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 1a3 3 0 0 0-3 3v12a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
              </svg>
            </button>
            <button class="input-btn tts-btn" title="Voice Output (TTS)" id="ttsToggleBtn" onclick="toggleTTS()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <path d="M15.54 5.47A9 9 0 0 1 19 13a9 9 0 0 1-4.46 7.53"></path>
              </svg>
            </button>
            <button class="input-btn send-btn" title="Send" onclick="sendMessage()">→</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    let currentThread = null;
    let isSidebarCollapsed = false;
    let conversationId = null;
    let checkInStep = 0;
    let checkInData = {};

    // Auto-resize textarea to fit content
    function autoResizeInput() {
      const input = document.getElementById('messageInput');
      input.style.height = 'auto';
      const scrollHeight = input.scrollHeight;
      const maxHeight = 120;
      input.style.height = Math.min(scrollHeight, maxHeight) + 'px';
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobileOverlay');
      
      if (window.innerWidth <= 768) {
        sidebar.classList.toggle('open');
        overlay.classList.toggle('active');
      } else {
        sidebar.classList.toggle('collapsed');
        isSidebarCollapsed = !isSidebarCollapsed;
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function openSettings() {
      document.getElementById('settingsModal').classList.add('active');
      // Load current theme setting
      const currentTheme = localStorage.getItem('veraTheme') || 'dark';
      updateThemeButtons(currentTheme);
    }

    // Open profile modal and load user data
    async function openProfile() {
      const modal = document.getElementById('profileModal');
      modal.classList.add('active');
      
      try {
        const userEmail = localStorage.getItem('userEmail');
        if (!userEmail) {
          showProfileMessage('Please sign in first', 'error');
          return;
        }

        // Get user profile data
        const response = await fetch(`/api/profile-update?email=${encodeURIComponent(userEmail)}`);
        if (!response.ok) throw new Error('Failed to load profile');
        
        const user = await response.json();
        
        // Display user info
        document.getElementById('profileEmail').textContent = user.email;
        document.getElementById('profilePhone').value = user.phone_number || '';
        
        // Display subscription status
        const subResponse = await fetch(`/api/subscription-status?email=${encodeURIComponent(userEmail)}`);
        if (subResponse.ok) {
          const subData = await subResponse.json();
          const sub = subData.subscription;
          
          if (sub.on_trial && sub.trial_end) {
            document.getElementById('subscriptionStatus').textContent = '⏱️ On Trial';
            document.getElementById('trialEndDate').textContent = new Date(sub.trial_end).toLocaleDateString();
            document.getElementById('trialInfoField').style.display = 'flex';
            document.getElementById('subscriptionInfoField').style.display = 'none';
          } else if (sub.is_paid && sub.subscription_end) {
            document.getElementById('subscriptionStatus').textContent = '✅ Paid Subscriber';
            document.getElementById('subscriptionEndDate').textContent = new Date(sub.subscription_end).toLocaleDateString();
            document.getElementById('subscriptionInfoField').style.display = 'flex';
            document.getElementById('trialInfoField').style.display = 'none';
          } else if (localStorage.getItem('subscription_status') === 'payment_failed') {
            document.getElementById('subscriptionStatus').textContent = '⚠️ Payment Failed';
            document.getElementById('trialInfoField').style.display = 'none';
            document.getElementById('subscriptionInfoField').style.display = 'none';
            // Show retry button
            const infoDiv = document.createElement('div');
            infoDiv.style.cssText = 'margin-top: 1rem; padding: 1rem; background: rgba(230, 126, 34, 0.1); border-radius: 8px; border: 1px solid rgba(230, 126, 34, 0.3);';
            infoDiv.innerHTML = `
              <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">Your payment method failed. Please update your payment method to continue using VERA.</p>
              <button onclick="openCheckout();" style="padding: 0.5rem 1rem; background: #e67e22; border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: 600;">Retry Payment</button>
            `;
            document.getElementById('profileContent').appendChild(infoDiv);
          } else {
            document.getElementById('subscriptionStatus').textContent = '⭐ Trial Expired';
            document.getElementById('trialInfoField').style.display = 'none';
            document.getElementById('subscriptionInfoField').style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        showProfileMessage('Error loading profile', 'error');
      }
    }

    // Update user phone number
    async function updateProfilePhone() {
      const userEmail = localStorage.getItem('userEmail');
      const phone = document.getElementById('profilePhone').value.trim();
      
      if (!userEmail) {
        showProfileMessage('Please sign in first', 'error');
        return;
      }
      
      if (!phone) {
        showProfileMessage('Please enter a phone number', 'error');
        return;
      }

      try {
        const response = await fetch('/api/profile-update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: userEmail, phone_number: phone })
        });

        const result = await response.json();
        
        if (!response.ok) {
          if (result.code === 'DUPLICATE_PHONE') {
            showProfileMessage('This phone number is already registered', 'error');
          } else {
            showProfileMessage(result.error || 'Failed to update phone', 'error');
          }
          return;
        }

        showProfileMessage('Phone number saved successfully', 'success');
        setTimeout(() => {
          showProfileMessage('', '');
        }, 3000);
      } catch (error) {
        console.error('Error updating phone:', error);
        showProfileMessage('Error saving phone number', 'error');
      }
    }

    // Show profile message
    function showProfileMessage(message, type) {
      const msgEl = document.getElementById('profileMessage');
      msgEl.textContent = message;
      msgEl.className = 'profile-message';
      if (type) msgEl.classList.add(type);
    }

    // Logout user
    function logoutUser() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.clear();
        window.location.href = '/';
      }
    }

    // Toggle profile menu
    function toggleProfileMenu() {
      const menu = document.getElementById('profileMenu');
      const sidebar = document.querySelector('.sidebar-footer');
      
      menu.classList.toggle('active');
      
      // Update email in menu
      const userEmail = localStorage.getItem('userEmail') || 'no-email@example.com';
      const userName = localStorage.getItem('userName') || 'User';
      
      document.getElementById('profileMenuEmail').textContent = userEmail;
      
      // Update avatar initial and name display
      const initial = userName.charAt(0).toUpperCase();
      document.getElementById('userAvatarInitial').textContent = initial;
      document.getElementById('userNameDisplay').textContent = userName;
      
      // Close menu when clicking outside
      if (menu.classList.contains('active')) {
        setTimeout(() => {
          document.addEventListener('click', closeProfileMenuOnClickOutside);
        }, 0);
      } else {
        document.removeEventListener('click', closeProfileMenuOnClickOutside);
      }
    }

    function closeProfileMenuOnClickOutside(event) {
      const menu = document.getElementById('profileMenu');
      const profileArea = document.querySelector('.user-profile');
      
      if (!menu.contains(event.target) && !profileArea.contains(event.target)) {
        menu.classList.remove('active');
        document.removeEventListener('click', closeProfileMenuOnClickOutside);
      }
    }

    // Menu item handlers
    function openUpgradePlan() {
      const userEmail = localStorage.getItem('userEmail') || '';
      const userPhone = localStorage.getItem('userPhone') || '';
      
      if (!userEmail) {
        alert('Please sign in first to upgrade');
        return;
      }
      
      document.getElementById('profileMenu').classList.remove('active');
      const checkoutUrl = `/checkout?email=${encodeURIComponent(userEmail)}&phone=${encodeURIComponent(userPhone)}&plan=monthly`;
      window.location.href = checkoutUrl;
    }

    function openOrders() {
      document.getElementById('profileMenu').classList.remove('active');
      alert('Orders feature coming soon');
    }

    function openPersonalization() {
      document.getElementById('profileMenu').classList.remove('active');
      alert('Personalization settings coming soon');
    }

    function openHelp() {
      document.getElementById('profileMenu').classList.remove('active');
      alert('Help & Support coming soon');
    }

    function setTheme(theme) {
      localStorage.setItem('veraTheme', theme);
      updateThemeButtons(theme);
      
      const html = document.documentElement;
      html.classList.remove('light-theme', 'rose-theme');
      
      if (theme === 'light') {
        html.classList.add('light-theme');
      } else if (theme === 'rose') {
        html.classList.add('rose-theme');
      }
    }

    function updateThemeButtons(theme) {
      document.getElementById('themeLight').classList.toggle('active', theme === 'light');
      document.getElementById('themeDark').classList.toggle('active', theme === 'dark');
      document.getElementById('themeRose').classList.toggle('active', theme === 'rose');
    }

    function toggleNotifications() {
      const toggle = document.getElementById('notificationsToggle');
      const status = document.getElementById('notificationStatus');
      const isEnabled = toggle.checked;
      
      localStorage.setItem('veraNotifications', isEnabled);
      status.textContent = isEnabled ? 'ON' : 'OFF';
    }

    // Load settings on page load
    window.addEventListener('load', function() {
      // Load theme
      const savedTheme = localStorage.getItem('veraTheme') || 'dark';
      if (savedTheme === 'light') {
        document.documentElement.classList.add('light-theme');
        updateThemeButtons('light');
      } else if (savedTheme === 'rose') {
        document.documentElement.classList.add('rose-theme');
        updateThemeButtons('rose');
      } else {
        updateThemeButtons('dark');
      }
      
      // Load notifications
      const notificationsEnabled = localStorage.getItem('veraNotifications') !== 'false';
      document.getElementById('notificationsToggle').checked = notificationsEnabled;
      document.getElementById('notificationStatus').textContent = notificationsEnabled ? 'ON' : 'OFF';
      
      // Initialize user profile avatar and name
      const userName = localStorage.getItem('userName') || 'User';
      const initial = userName.charAt(0).toUpperCase();
      document.getElementById('userAvatarInitial').textContent = initial;
      document.getElementById('userNameDisplay').textContent = userName;
      
      // Initialize saved messages display
      updateSavedMessagesDisplay();
      
      // Check trial status on page load
      checkAndShowTrialNotification();
      
      // Check trial status every 30 seconds
      setInterval(() => {
        checkAndShowTrialNotification();
      }, 30000);
    });

    function shareThread() {
      document.getElementById('shareModal').classList.add('active');
      document.getElementById('shareMessage').classList.remove('visible');
    }

    function copySessionLink() {
      const link = window.location.href;
      navigator.clipboard.writeText(link).then(() => {
        showShareMessage('✓ Session link copied to clipboard!');
      }).catch(() => {
        showShareMessage('Could not copy. Try again!');
      });
    }

    function copyConversation() {
      const messages = document.querySelectorAll('.message-bubble');
      let text = 'VERA Session Transcript\n' + '='.repeat(40) + '\n\n';
      
      messages.forEach(msg => {
        if (msg.parentElement.classList.contains('message-vera')) {
          text += 'VERA: ' + msg.textContent + '\n\n';
        } else {
          text += 'You: ' + msg.textContent + '\n\n';
        }
      });
      
      navigator.clipboard.writeText(text).then(() => {
        showShareMessage('✓ Conversation copied to clipboard!');
      }).catch(() => {
        showShareMessage('Could not copy. Try again!');
      });
    }

    function shareViaEmail() {
      const subject = 'VERA Conversation';
      const body = "I'd like to share this VERA session with you:\n\n" + window.location.href;
      const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = mailtoLink;
    }

    function showShareMessage(message) {
      const messageEl = document.getElementById('shareMessage');
      messageEl.textContent = message;
      messageEl.classList.add('visible');
      setTimeout(() => {
        messageEl.classList.remove('visible');
      }, 3000);
    }

    function showMore() {
      document.getElementById('moreModal').classList.add('active');
    }

    function exportConversation() {
      const messages = document.querySelectorAll('.message');
      let text = 'VERA Session Transcript\n' + '='.repeat(50) + '\n\n';
      
      messages.forEach(msg => {
        const bubble = msg.querySelector('.message-bubble');
        if (msg.classList.contains('message-vera')) {
          text += 'VERA: ' + bubble.textContent + '\n\n';
        } else {
          text += 'You: ' + bubble.textContent + '\n\n';
        }
      });
      
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
      element.setAttribute('download', 'vera-conversation-' + new Date().toISOString().slice(0, 10) + '.txt');
      element.style.display = 'none';
      document.body.appendChild(element);
      element.click();
      document.body.removeChild(element);
      
      closeModal('moreModal');
    }

    function openReportIssue() {
      closeModal('moreModal');
      document.getElementById('reportModal').classList.add('active');
    }

    function submitIssueReport() {
      const description = document.getElementById('issueDescription').value;
      const email = document.getElementById('issueEmail').value;
      
      if (!description.trim()) {
        showReportMessage('Please describe the issue');
        return;
      }
      
      // Here you would send to your backend
      console.log('Issue Report:', { description, email, timestamp: new Date() });
      
      showReportMessage('✓ Thank you! Your report has been sent.');
      setTimeout(() => {
        document.getElementById('issueDescription').value = '';
        document.getElementById('issueEmail').value = '';
        closeModal('reportModal');
      }, 2000);
    }

    function showReportMessage(msg) {
      const messageEl = document.getElementById('reportMessage');
      messageEl.textContent = msg;
      messageEl.classList.add('visible');
    }

    function openAboutVERA() {
      closeModal('moreModal');
      document.getElementById('aboutModal').classList.add('active');
    }

    function openHistory() {
      closeModal('moreModal');
      loadHistory();
      document.getElementById('historyModal').classList.add('active');
    }

    function loadHistory() {
      const historyList = document.getElementById('historyList');
      const conversationHistory = JSON.parse(localStorage.getItem('veraConversationHistory') || '[]');
      
      if (conversationHistory.length === 0) {
        historyList.innerHTML = '<div class="history-empty">No conversations yet. Start chatting with VERA!</div>';
        return;
      }
      
      historyList.innerHTML = conversationHistory.map((conv, idx) => `
        <div class="history-item">
          <div class="history-item-content" onclick="loadConversation(${idx})">
            <div class="history-item-title">${conv.title || 'Conversation ' + (idx + 1)}</div>
            <div class="history-item-time">${new Date(conv.timestamp).toLocaleString()}</div>
          </div>
          <button class="history-item-delete" onclick="deleteConversation(${idx})">×</button>
        </div>
      `).join('');
    }

    function loadConversation(idx) {
      const conversationHistory = JSON.parse(localStorage.getItem('veraConversationHistory') || '[]');
      const conv = conversationHistory[idx];
      
      if (conv && conv.messages) {
        clearMessages();
        document.getElementById('welcomeState').style.display = 'none';
        document.getElementById('messagesContainer').classList.add('active');
        
        conv.messages.forEach(msg => {
          addMessage(msg.role, msg.content);
        });
      }
      
      closeModal('historyModal');
    }

    function deleteConversation(idx) {
      if (confirm('Delete this conversation?')) {
        const conversationHistory = JSON.parse(localStorage.getItem('veraConversationHistory') || '[]');
        conversationHistory.splice(idx, 1);
        localStorage.setItem('veraConversationHistory', JSON.stringify(conversationHistory));
        loadHistory();
      }
    }

    function saveConversation() {
      const messages = Array.from(document.querySelectorAll('.message')).map(msg => {
        const bubble = msg.querySelector('.message-bubble');
        const isVera = msg.classList.contains('message-vera');
        return {
          role: isVera ? 'vera' : 'user',
          content: bubble.textContent
        };
      });
      
      if (messages.length === 0) return;
      
      const conversationHistory = JSON.parse(localStorage.getItem('veraConversationHistory') || '[]');
      conversationHistory.unshift({
        title: 'Conversation ' + new Date().toLocaleDateString(),
        timestamp: new Date().toISOString(),
        messages: messages
      });
      
      // Keep only last 20 conversations
      if (conversationHistory.length > 20) {
        conversationHistory.pop();
      }
      
      localStorage.setItem('veraConversationHistory', JSON.stringify(conversationHistory));
    }

    // This openProfile function is now properly implemented above with modal support
    // (the old alert-based version has been replaced with the new modal version)

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const maxSize = 5 * 1024 * 1024; // 5MB
      if (file.size > maxSize) {
        alert('File size exceeds 5MB limit');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const fileName = file.name;
        const fileType = file.type;
        
        // Show file preview or info
        addMessage('user', `📎 Attached: ${fileName} (${(file.size / 1024).toFixed(2)} KB)`);
        
        // Send file info to API
        showTyping();
        
        fetch('/api/file-upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: `I've attached a file: ${fileName}. Type: ${fileType}. Please analyze or process this file.`,
            conversationId: conversationId,
            email: userEmail || undefined,
            anonId: anonId || undefined,
            attachment: {
              name: fileName,
              type: fileType,
              size: file.size
            }
          })
        })
          .then(response => response.json())
          .then(data => {
            hideTyping();
            if (data.conversationId) {
              conversationId = data.conversationId;
            }
            const veraResponse = data.response || "I've received your file. How can I help you with it?";
            addMessage('vera', veraResponse);
          })
          .catch(error => {
            console.error('Error:', error);
            hideTyping();
            addMessage('vera', "I had trouble processing your file. Please try again.");
          });
      };
      
      reader.readAsArrayBuffer(file);
      
      // Reset input
      event.target.value = '';
    }

    function attachFile() {
      document.getElementById('fileInput').click();
    }

    function startVoice() {
      // Check browser support for Web Speech API
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      
      if (!SpeechRecognition) {
        alert('Speech recognition is not supported in your browser. Please use Chrome, Edge, or Safari.');
        return;
      }
      
      const recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = true;
      recognition.lang = 'en-US';
      
      const voiceBtn = document.getElementById('voiceBtn');
      voiceBtn.classList.add('listening');
      
      recognition.onstart = function() {
        console.log('Listening...');
      };
      
      recognition.onresult = function(event) {
        let interimTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          
          if (event.results[i].isFinal) {
            // Final result - add to message input
            const input = document.getElementById('messageInput');
            input.value += transcript + ' ';
            input.focus();
          } else {
            // Interim result
            interimTranscript += transcript;
          }
        }
      };
      
      recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        let errorMsg = 'Speech recognition error. Please try again.';
        
        if (event.error === 'no-speech') {
          errorMsg = 'No speech detected. Please speak clearly.';
        } else if (event.error === 'network') {
          errorMsg = 'Network error. Check your connection.';
        }
        
        addMessage('vera', errorMsg);
      };
      
      recognition.onend = function() {
        voiceBtn.classList.remove('listening');
      };
      
      recognition.start();
    }

    function newThread() {
      saveConversation(); // Save current conversation before starting new one
      clearMessages();
      conversationId = null;
      checkInStep = 0;
      checkInData = {};
      document.getElementById('welcomeState').style.display = 'block';
      document.getElementById('messageInput').focus();
    }

    function loadThread(id) {
      currentThread = id;
      document.querySelectorAll('.thread-item').forEach(item => item.classList.remove('active'));
      event.currentTarget.closest('.thread-item').classList.add('active');
      
      if (id === 1) {
        startMorningCheckIn();
      } else if (id === 2) {
        openBreathingSession();
      } else if (id === 3) {
        openGroundingSession();
      } else if (id === 4) {
        startJournalingSession();
      } else if (id === 5) {
        startPatternRecognition();
      } else if (id === 6) {
        startProcessingEmotions();
      } else if (id === 7) {
        startDecoding();
      } else {
        loadDemoMessages(id);
      }
      
      // On mobile, close the sidebar to show chat, but keep menu accessible
      if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileOverlay');
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
      }
    }

    function startMorningCheckIn() {
      clearMessages();
      checkInStep = 0;
      checkInData = {};
      document.getElementById('welcomeState').style.display = 'none';
      document.getElementById('messagesContainer').classList.add('active');
      
      // Start the check-in
      setTimeout(() => {
        addMessage('vera', "Good morning. I'm here to help you understand what's present in your body and nervous system right now.");
        
        setTimeout(() => {
          addMessage('vera', "Let's begin gently. First, I'd like to know: When you woke up this morning, what was the first sensation or feeling you noticed?");
          checkInStep = 1;
        }, 1500);
      }, 500);
    }

    function processMorningCheckIn(userResponse) {
      if (checkInStep === 1) {
        checkInData.firstFeeling = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `Thank you for noticing that. "${userResponse}" - that tells me something important about your current state.\n\nNow, can you locate where in your body you feel this most strongly? Is it in your chest, belly, throat, shoulders, or somewhere else?`);
          checkInStep = 2;
        }, 800);
      } 
      else if (checkInStep === 2) {
        checkInData.bodyLocation = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `I'm with you. So you're feeling this in your ${userResponse}.\n\nOn a scale of 0-10, how activated or calm does your nervous system feel right now? 0 being very calm, 10 being very activated.`);
          checkInStep = 3;
        }, 800);
      }
      else if (checkInStep === 3) {
        checkInData.activation = userResponse;
        
        setTimeout(() => {
          const activation = parseInt(userResponse);
          let guidance = '';
          
          if (activation <= 3) {
            guidance = 'Your nervous system is quite calm this morning. This is a beautiful starting point. Today, you might focus on gentle movement and noticing stability.';
          } else if (activation <= 6) {
            guidance = "You're in a moderate state - engaged but not overwhelmed. This is a good time for grounded activities and conscious choice-making.";
          } else {
            guidance = 'Your nervous system is more activated right now. This might call for some calming practices - breathing, gentle movement, or grounding techniques could help.';
          }
          
          addMessage('vera', guidance + "\n\nWould you like me to guide you through a breathing exercise, or would you prefer to explore what's underneath these sensations?");
          checkInStep = 4;
        }, 800);
      }
      else if (checkInStep === 4) {
        checkInData.preference = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `Thank you for this check-in. I now understand where you're at this morning.\n\nRemember: your nervous system is always doing its best to protect you. Whatever you're feeling is valid and important.\n\nI'm here throughout your day if you need to check in again.`);
          checkInStep = 0;
        }, 800);
      }
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      document.getElementById('welcomeState').style.display = 'none';
      document.getElementById('messagesContainer').classList.add('active');
      
      addMessage('user', message);
      input.value = '';
      
      // Check and show trial notification during chat
      checkAndShowTrialNotification();
      
      // If we're in a morning check-in flow, process it
      if (checkInStep > 0 && checkInStep < 4) {
        processMorningCheckIn(message);
        return;
      }
      
      // If we're in a journaling flow, process it
      if (journalingStep > 0 && journalingStep < 5) {
        processJournalingResponse(message);
        return;
      }
      
      // If we're in a pattern recognition flow, process it
      if (patternStep > 0 && patternStep < 7) {
        processPatternResponse(message);
        return;
      }
      
      // If we're in an emotion processing flow, process it
      if (emotionStep > 0 && emotionStep < 6) {
        processEmotionResponse(message);
        return;
      }
      
      // If we're in a decoding flow, process it
      if (decodingStep > 0 && decodingStep < 6) {
        processDecodingResponse(message);
        return;
      }
      
      // Otherwise send to VERA API
      showTyping();
      
      fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: message,
          conversationId: conversationId
        })
      })
        .then(response => response.json())
        .then(data => {
          hideTyping();
          
          if (data.conversationId) {
            conversationId = data.conversationId;
          }
          
          const veraResponse = data.response || "I'm here with you. What would you like to explore?";
          addMessage('vera', veraResponse);
        })
        .catch(error => {
          console.error('Error:', error);
          hideTyping();
          addMessage('vera', "I'm experiencing a connection issue. Please try again.");
        });
    }

    function addMessage(role, content) {
      const container = document.getElementById('messagesContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message message-${role}`;
      
      // Generate unique message ID
      const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      messageDiv.dataset.messageId = messageId;
      
      // Check if this message is already saved
      const savedMessages = JSON.parse(localStorage.getItem('veraUnicasSavedMessages') || '[]');
      const isSaved = savedMessages.some(m => m.id === messageId);
      
      if (role === 'vera') {
        messageDiv.innerHTML = `
          <div class="message-avatar"></div>
          <div class="message-bubble">${content}</div>
          <div class="message-actions">
            <button class="message-action-btn ${isSaved ? 'saved' : ''}" title="${isSaved ? 'Unsave message' : 'Save message'}" onclick="toggleSaveMessage('${messageId}', this)">
              ${isSaved ? '♥' : '♡'}
            </button>
            <button class="message-action-btn" title="Delete message" onclick="deleteMessageFromChat('${messageId}')">
              ×
            </button>
          </div>
        `;
        
        // Trigger TTS for VERA message
        setTimeout(() => {
          speakMessage(content);
        }, 100);
      } else {
        messageDiv.innerHTML = `
          <div class="message-bubble">${content}</div>
          <div class="message-actions">
            <button class="message-action-btn" title="Delete message" onclick="deleteMessageFromChat('${messageId}')">
              ×
            </button>
          </div>
        `;
      }
      
      container.appendChild(messageDiv);
      document.getElementById('chatArea').scrollTop = document.getElementById('chatArea').scrollHeight;
    }

    function toggleSaveMessage(messageId, button) {
      const savedMessages = JSON.parse(localStorage.getItem('veraUnicasSavedMessages') || '[]');
      const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
      const messageContent = messageElement.querySelector('.message-bubble').textContent;
      
      const existingIndex = savedMessages.findIndex(m => m.id === messageId);
      
      if (existingIndex >= 0) {
        // Remove from saved
        savedMessages.splice(existingIndex, 1);
        button.textContent = '♡';
        button.classList.remove('saved');
      } else {
        // Add to saved
        savedMessages.push({
          id: messageId,
          content: messageContent,
          timestamp: new Date().toISOString(),
          role: messageElement.classList.contains('message-vera') ? 'vera' : 'user'
        });
        button.textContent = '♥';
        button.classList.add('saved');
      }
      
      localStorage.setItem('veraUnicasSavedMessages', JSON.stringify(savedMessages));
      updateSavedMessagesDisplay();
    }

    function deleteMessageFromChat(messageId) {
      const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
      if (messageElement) {
        messageElement.remove();
      }
      
      // Also remove from saved if it was saved
      const savedMessages = JSON.parse(localStorage.getItem('veraUnicasSavedMessages') || '[]');
      const index = savedMessages.findIndex(m => m.id === messageId);
      if (index >= 0) {
        savedMessages.splice(index, 1);
        localStorage.setItem('veraUnicasSavedMessages', JSON.stringify(savedMessages));
        updateSavedMessagesDisplay();
      }
    }

    function updateSavedMessagesDisplay() {
      const container = document.getElementById('savedMessagesContainer');
      const savedMessages = JSON.parse(localStorage.getItem('veraUnicasSavedMessages') || '[]');
      
      if (savedMessages.length === 0) {
        container.innerHTML = `
          <div class="thread-item" style="padding: 0.75rem; text-align: center; color: var(--text-tertiary); font-size: 0.85rem;">
            No saved messages yet
          </div>
        `;
      } else {
        container.innerHTML = savedMessages.map((msg, idx) => {
          const preview = msg.content.substring(0, 30) + (msg.content.length > 30 ? '...' : '');
          return `
            <div class="thread-item" onclick="viewSavedMessage(${idx})">
              <div class="thread-content">
                <div class="thread-title">${msg.role === 'vera' ? 'VERA' : 'You'}</div>
                <div class="thread-preview">${preview}</div>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    function viewSavedMessage(idx) {
      const savedMessages = JSON.parse(localStorage.getItem('veraUnicasSavedMessages') || '[]');
      if (savedMessages[idx]) {
        const msg = savedMessages[idx];
        clearMessages();
        document.getElementById('welcomeState').style.display = 'none';
        document.getElementById('messagesContainer').classList.add('active');
        addMessage(msg.role, msg.content);
      }
    }

    function clearMessages() {
      document.getElementById('messagesContainer').innerHTML = '';
      document.getElementById('messagesContainer').classList.remove('active');
    }

    function showTyping() {
      document.getElementById('typingIndicator').classList.add('active');
      document.getElementById('chatArea').scrollTop = document.getElementById('chatArea').scrollHeight;
    }

    function hideTyping() {
      document.getElementById('typingIndicator').classList.remove('active');
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function loadDemoMessages(threadId) {
      clearMessages();
      document.getElementById('welcomeState').style.display = 'none';
      document.getElementById('messagesContainer').classList.add('active');
      
      const threads = {
        2: [
          { role: 'user', content: "Let's do the breathing exercise." },
          { role: 'vera', content: "Perfect. Find a comfortable position. We'll breathe together slowly:\n\n• Inhale for 4 counts\n• Hold for 4 counts\n• Exhale for 6 counts (longer exhale calms nervous system)\n\nLet's do 5 rounds together." }
        ]
      };
      
      (threads[threadId] || []).forEach(msg => addMessage(msg.role, msg.content));
    }

    function quickAction(action) {
      const actions = {
        breathe: "Can we do a breathing exercise?",
        checkin: "I'd like a nervous system check-in",
        patterns: "Help me understand my patterns",
        help: "I need support right now"
      };
      document.getElementById('messageInput').value = actions[action] || '';
      document.getElementById('messageInput').focus();
    }

    // Close modals when clicking outside
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('active');
      }
    });

    // BREATHING SESSION
    let breathingActive = false;
    let breathingRound = 0;
    let breathingStartTime = 0;
    let breathCount = 0;

    function openBreathingSession() {
      document.getElementById('breathingSession').classList.add('active');
      breathingRound = 0;
      breathCount = 0;
      breathingActive = false;
      document.getElementById('breathingOrb').classList.remove('exhale');
      document.getElementById('breathingInstruction').textContent = 'Get ready...';
      document.getElementById('breathingRound').textContent = '1';
      document.getElementById('breathCount').textContent = '0';
      document.getElementById('breathTime').textContent = '0s';
    }

    function closeBreathingSession() {
      document.getElementById('breathingSession').classList.remove('active');
      breathingActive = false;
      
      if (breathingRound > 0) {
        clearMessages();
        document.getElementById('welcomeState').style.display = 'none';
        document.getElementById('messagesContainer').classList.add('active');
        
        setTimeout(() => {
          addMessage('vera', `Wonderful work. You completed ${breathingRound} rounds of breathing.\n\nHow are you feeling now? Take a moment to notice what's different in your body.`);
          checkInStep = 5;
        }, 500);
      }
    }

    function closBreathingSession() {
      closeBreathingSession();
    }

    function startBreathingSession() {
      breathingActive = true;
      breathingRound = 1;
      breathCount = 0;
      breathingStartTime = Date.now();
      document.getElementById('breathingControls').innerHTML = '<button class="breathing-btn breathing-btn-secondary" onclick="closeBreathingSession()">End Session</button>';
      runBreathingCycle();
    }

    function runBreathingCycle() {
      if (!breathingActive || breathingRound > 5) {
        if (breathingRound > 5) {
          closeBreathingSession();
        }
        return;
      }

      // Inhale 4 seconds
      document.getElementById('breathingInstruction').textContent = 'Inhale slowly...';
      document.getElementById('breathingOrb').classList.remove('exhale');
      document.getElementById('breathingRound').textContent = breathingRound;

      setTimeout(() => {
        if (!breathingActive) return;
        document.getElementById('breathingInstruction').textContent = 'Hold...';
        
        setTimeout(() => {
          if (!breathingActive) return;
          document.getElementById('breathingInstruction').textContent = 'Exhale slowly...';
          document.getElementById('breathingOrb').classList.add('exhale');
          breathCount++;
          document.getElementById('breathCount').textContent = breathCount;
          updateBreathTime();
          
          setTimeout(() => {
            if (!breathingActive) return;
            breathingRound++;
            document.getElementById('breathingRound').textContent = breathingRound;
            runBreathingCycle();
          }, 6000);
        }, 4000);
      }, 4000);
    }

    function updateBreathTime() {
      const elapsed = Math.floor((Date.now() - breathingStartTime) / 1000);
      document.getElementById('breathTime').textContent = elapsed + 's';
    }

    // GROUNDING SESSION
    let groundingStep = 0;
    let groundingData = {};
    const groundingSteps = ['see', 'feel', 'hear', 'smell', 'taste'];

    function openGroundingSession() {
      document.getElementById('groundingSession').classList.add('active');
      groundingStep = 0;
      groundingData = {};
      updateGroundingDisplay();
    }

    function closeGroundingSession() {
      document.getElementById('groundingSession').classList.remove('active');
      
      if (groundingStep > 0) {
        clearMessages();
        document.getElementById('welcomeState').style.display = 'none';
        document.getElementById('messagesContainer').classList.add('active');
        
        setTimeout(() => {
          addMessage('vera', `Thank you for grounding yourself with the 5-4-3-2-1 technique.\n\nYou noticed ${groundingStep} sensory anchors. This brings you back to the present moment, where you're safe.\n\nHow do you feel now?`);
          checkInStep = 5;
        }, 500);
      }
    }

    let journalingStep = 0;
    let journalingData = {};

    function startJournalingSession() {
      clearMessages();
      journalingStep = 0;
      journalingData = {};
      document.getElementById('welcomeState').style.display = 'none';
      document.getElementById('messagesContainer').classList.add('active');
      
      setTimeout(() => {
        addMessage('vera', "Welcome to journaling. This is your space for reflection and self-discovery.");
        
        setTimeout(() => {
          addMessage('vera', "Let's begin: What emotions or experiences came up for you today?");
          journalingStep = 1;
        }, 1500);
      }, 500);
    }

    function processJournalingResponse(userResponse) {
      if (journalingStep === 1) {
        journalingData.emotions = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `Thank you for sharing that. "${userResponse}" - I hear you.\n\nNow, what do you think might be underneath these feelings? What need or value might they be pointing to?`);
          journalingStep = 2;
        }, 800);
      }
      else if (journalingStep === 2) {
        journalingData.underlying = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `That's a beautiful insight. "${userResponse}" - that's important to honor.\n\nLooking back at today, what's one small thing you did well, or one moment you felt grounded?`);
          journalingStep = 3;
        }, 800);
      }
      else if (journalingStep === 3) {
        journalingData.positive = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `I love that you noticed that. "${userResponse}" - these moments matter.\n\nFinally, what's one thing you want to remember or honor about yourself as we move into tomorrow?`);
          journalingStep = 4;
        }, 800);
      }
      else if (journalingStep === 4) {
        journalingData.intention = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `Thank you for this beautiful reflection. "${userResponse}" - hold that close.\n\nYour journaling today shows deep self-awareness. Remember: you're exactly where you need to be. 💫`);
          journalingStep = 5;
        }, 800);
      }
    }

    let patternStep = 0;
    let patternData = {};

    function startPatternRecognition() {
      clearMessages();
      patternStep = 0;
      patternData = {};
      document.getElementById('welcomeState').style.display = 'none';
      document.getElementById('messagesContainer').classList.add('active');
      
      setTimeout(() => {
        addMessage('vera', "Welcome to Pattern Recognition. Here we explore the patterns that shape your nervous system responses.");
        
        setTimeout(() => {
          addMessage('vera', "Think of a recent situation where you felt triggered, activated, or stressed. What happened?");
          patternStep = 1;
        }, 1500);
      }, 500);
    }

    function processPatternResponse(userResponse) {
      if (patternStep === 1) {
        patternData.situation = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `Got it. "${userResponse}" - that's the trigger.\n\nNow, what physical sensations did you notice in your body? Where did you feel it?`);
          patternStep = 2;
        }, 800);
      }
      else if (patternStep === 2) {
        patternData.bodySensations = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `Thank you for noticing that. "${userResponse}" - your body wisdom is key.\n\nWhat thoughts or beliefs came up? What did you tell yourself in that moment?`);
          patternStep = 3;
        }, 800);
      }
      else if (patternStep === 3) {
        patternData.thoughts = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `I see. "${userResponse}" - that's the story your nervous system tells.\n\nHow did you respond? What did you do or say?`);
          patternStep = 4;
        }, 800);
      }
      else if (patternStep === 4) {
        patternData.response = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `Thank you for sharing that. "${userResponse}" - now I see the full pattern.\n\nLooking at this whole cycle - trigger → sensation → thought → response - what do you notice? Is there a deeper need or fear underneath?`);
          patternStep = 5;
        }, 800);
      }
      else if (patternStep === 5) {
        patternData.insight = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `This is profound. "${userResponse}" - you've identified the root.\n\nNow, knowing this pattern, what's ONE different choice you could make next time? Something small but meaningful?`);
          patternStep = 6;
        }, 800);
      }
      else if (patternStep === 6) {
        patternData.newChoice = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `I love that. "${userResponse}" - that's your new possibility.\n\nPatterns are not destiny. You have choice. You have agency. This insight is your power. 🌟`);
          patternStep = 7;
        }, 800);
      }
    }

    let emotionStep = 0;
    let emotionData = {};

    function startProcessingEmotions() {
      clearMessages();
      emotionStep = 0;
      emotionData = {};
      document.getElementById('welcomeState').style.display = 'none';
      document.getElementById('messagesContainer').classList.add('active');
      
      setTimeout(() => {
        addMessage('vera', "Welcome to Processing Emotions. This is a safe space to feel what you're feeling.");
        
        setTimeout(() => {
          addMessage('vera', "Tell me - what difficult emotion or feeling are you carrying right now? Don't filter it, just name it.");
          emotionStep = 1;
        }, 1500);
      }, 500);
    }

    function processEmotionResponse(userResponse) {
      if (emotionStep === 1) {
        emotionData.emotion = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `I hear you. "${userResponse}" - that takes courage to name.\n\nWhen did this emotion first appear? What was happening?`);
          emotionStep = 2;
        }, 800);
      }
      else if (emotionStep === 2) {
        emotionData.origin = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `Thank you for sharing that. "${userResponse}" - now I understand the timeline.\n\nWhat would it mean if you allowed yourself to fully feel this emotion? What's the risk?`);
          emotionStep = 3;
        }, 800);
      }
      else if (emotionStep === 3) {
        emotionData.risk = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `That's real. "${userResponse}" - I see what you're protecting yourself from.\n\nBut here's the truth: emotions are like waves. They rise, they peak, and they pass. What if you let this one move through you instead of holding it back?`);
          emotionStep = 4;
        }, 800);
      }
      else if (emotionStep === 4) {
        emotionData.permission = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `Beautiful. "${userResponse}" - that's the permission you needed to give yourself.\n\nWhat do you need right now? Who or what could help you feel supported?`);
          emotionStep = 5;
        }, 800);
      }
      else if (emotionStep === 5) {
        emotionData.support = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `"${userResponse}" - that's wisdom. You know what you need.\n\nThis emotion you're carrying? It's not weakness. It's your humanity. It's your depth. It's your capacity to care.\n\nYou're allowed to feel. You're allowed to heal. 💜`);
          emotionStep = 6;
        }, 800);
      }
    }

    let decodingStep = 0;
    let decodingData = {};

    function startDecoding() {
      clearMessages();
      decodingStep = 0;
      decodingData = {};
      document.getElementById('welcomeState').style.display = 'none';
      document.getElementById('messagesContainer').classList.add('active');
      
      setTimeout(() => {
        addMessage('vera', "Welcome to Decoding. Let's decode what messages or words have been affecting you.");
        
        setTimeout(() => {
          addMessage('vera', "Is there something someone said to you - or something you tell yourself - that keeps echoing in your mind? What is it?");
          decodingStep = 1;
        }, 1500);
      }, 500);
    }

    function processDecodingResponse(userResponse) {
      if (decodingStep === 1) {
        decodingData.message = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `I hear that. "${userResponse}" - that's a powerful message carrying weight.\n\nWhen you hear or say this, what feeling arises in your body? What emotion shows up?`);
          decodingStep = 2;
        }, 800);
      }
      else if (decodingStep === 2) {
        decodingData.feeling = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `So "${userResponse}" comes up. Thank you for noticing that.\n\nNow, where do you think this message came from originally? Who or what planted this belief in you?`);
          decodingStep = 3;
        }, 800);
      }
      else if (decodingStep === 3) {
        decodingData.origin = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `Ah. "${userResponse}" - now we see the root.\n\nLet me ask you something important: Is this belief actually TRUE? Or is it a story someone else wrote that you've been carrying?`);
          decodingStep = 4;
        }, 800);
      }
      else if (decodingStep === 4) {
        decodingData.truth = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `That's the clarity. "${userResponse}"\n\nSo what would you want to tell yourself instead? What's the truth that counters this old message?`);
          decodingStep = 5;
        }, 800);
      }
      else if (decodingStep === 5) {
        decodingData.newMessage = userResponse;
        
        setTimeout(() => {
          addMessage('vera', `YES. "${userResponse}" - THAT is your truth.\n\nYou just decoded a lie and rewrote it. That message no longer owns you. You own it now. Your voice is louder. 🔑`);
          decodingStep = 6;
        }, 800);
      }
    }

    function nextGroundingStep() {
      const stepKey = groundingSteps[groundingStep];
      const input = document.getElementById(stepKey + 'Input');
      
      if (!input.value.trim()) {
        input.focus();
        return;
      }
      
      groundingData[stepKey] = input.value;
      groundingStep++;
      
      if (groundingStep >= 5) {
        closeGroundingSession();
      } else {
        updateGroundingDisplay();
      }
    }

    function updateGroundingDisplay() {
      const totalSteps = 5;
      const progress = (groundingStep / totalSteps) * 100;
      document.getElementById('groundingProgressBar').style.width = progress + '%';
      
      // Update step visibility
      for (let i = 0; i < totalSteps; i++) {
        const step = document.getElementById('step' + (i + 1));
        if (i < groundingStep) {
          step.style.display = 'none';
        } else if (i === groundingStep) {
          step.classList.add('active');
          step.style.display = 'block';
          document.getElementById(groundingSteps[i] + 'Input').focus();
        } else {
          step.classList.remove('active');
          step.style.display = 'block';
        }
      }
      
      // Update button text
      const nextBtn = document.getElementById('nextBtn');
      if (groundingStep === 4) {
        nextBtn.textContent = 'Complete';
      } else {
        nextBtn.textContent = 'Next';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // ==================== SESSION VALIDATION ====================
      
      /**
       * Session validation: Check if user is authenticated with valid session
       * Reads session info from HTTP-only cookies (set by /api/verify)
       * Validates session against server every 5 minutes
       */
      
      async function validateSession() {
        try {
          // Parse cookies properly - handle special characters and hex values
          const cookies = {};
          document.cookie.split('; ').forEach(c => {
            const [key, ...valueParts] = c.split('=');
            if (key && valueParts.length > 0) {
              cookies[key] = valueParts.join('='); // In case value contains '='
            }
          });
          
          const userEmail = cookies.session_email || localStorage.getItem('userEmail');
          const sessionToken = cookies.session_token; // Get the session token from cookie (hex string)
          const trialEnd = cookies.trial_end || localStorage.getItem('trialEnd');
          
          console.log('[validateSession] Cookies found:', {
            hasSessionEmail: !!cookies.session_email,
            hasSessionToken: !!cookies.session_token,
            sessionTokenLength: sessionToken?.length || 0
          });
          
          if (!userEmail) {
            console.warn('⚠️ No session email found - redirecting to checkout');
            window.location.href = '/checkout?reason=no_session';
            return false;
          }

          if (!sessionToken) {
            console.warn('⚠️ No session token found - redirecting to checkout');
            console.warn('📋 Available cookies:', Object.keys(cookies));
            window.location.href = `/checkout?email=${encodeURIComponent(userEmail)}&reason=no_session_token`;
            return false;
          }
          
          console.log('[validateSession] Sending validation request with:', {
            email: userEmail,
            tokenLength: sessionToken.length,
            action: 'validate'
          });
          
          // Validate session with server
          const response = await fetch('/api/auth/validate-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: userEmail,
              sessionToken: sessionToken,
              action: 'validate'
            }),
            credentials: 'include' // Include cookies in request (for other auth headers)
          });
          
          const data = await response.json();
          
          console.log('[validateSession] Response from server:', {
            valid: data.valid,
            status: response.status,
            error: data.error
          });
          
          if (!data.valid) {
            console.warn('❌ Session validation failed:', data.error);
            localStorage.removeItem('userEmail');
            localStorage.removeItem('trialEnd');
            window.location.href = `/checkout?email=${userEmail}&reason=${encodeURIComponent(data.error || 'Session expired')}`;
            return false;
          }
          
          // Update localStorage with current session info
          localStorage.setItem('userEmail', userEmail);
          localStorage.setItem('trialEnd', data.trialEnd || trialEnd);
          
          // Update trial badge if trial is active
          if (data.trial && data.trialEnd) {
            updateTrialBadge(data.trialEnd);
          }
          
          console.log(`✅ Session valid for ${userEmail}`, {
            trial: data.trial,
            subscription_status: data.subscription_status
          });
          
          return true;
        } catch (error) {
          console.error('❌ Session validation error:', error);
          // Don't redirect on network error - allow offline access
          return true;
        }
      }
      
      /**
       * Update trial badge with countdown
       */
      function updateTrialBadge(trialEndIso) {
        try {
          const trialEnd = new Date(trialEndIso);
          const now = new Date();
          const diffMs = trialEnd - now;
          
          // Store trial end time for the timer to use
          trialEndTime = trialEnd;
          
          // Update badge immediately
          const hours = Math.floor(diffMs / (1000 * 60 * 60));
          const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
          const timerText = `${hours}h ${minutes.toString().padStart(2, '0')}m`;
          
          const badge = document.getElementById('trialBadge');
          const badgeText = document.getElementById('trialBadgeText');
          
          if (badge && badgeText) {
            // Show the badge
            badge.style.display = 'flex';
            badgeText.textContent = timerText;
            
            console.log(`✅ Trial badge updated: ${timerText} remaining`);
            
            // Change badge color based on time remaining
            if (hours <= 1) {
              badge.style.borderColor = 'rgba(231, 76, 60, 0.6)';
              badge.style.background = 'linear-gradient(135deg, rgba(231, 76, 60, 0.15) 0%, rgba(192, 57, 43, 0.15) 100%)';
              badge.style.color = '#e74c3c';
            } else if (hours <= 6) {
              badge.style.borderColor = 'rgba(230, 126, 34, 0.6)';
              badge.style.background = 'linear-gradient(135deg, rgba(230, 126, 34, 0.15) 0%, rgba(192, 108, 25, 0.15) 100%)';
              badge.style.color = '#e67e22';
            } else if (hours <= 24) {
              badge.style.borderColor = 'rgba(241, 196, 15, 0.6)';
              badge.style.background = 'linear-gradient(135deg, rgba(241, 196, 15, 0.15) 0%, rgba(183, 149, 11, 0.15) 100%)';
              badge.style.color = '#f39c12';
            }
            
            // Start/restart the timer if not already running
            if (!trialTimerInterval) {
              trialTimerInterval = setInterval(updateTrialTimer, 60000); // Update every minute
              console.log('✅ Trial timer started');
            }
          }
        } catch (err) {
          console.warn('Could not update trial badge:', err);
        }
      }
      
      /**
       * Logout: Revoke session
       */
      async function logout() {
        try {
          const userEmail = localStorage.getItem('userEmail');
          
          await fetch('/api/auth/validate-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: userEmail,
              action: 'revoke'
            }),
            credentials: 'include'
          });
        } catch (err) {
          console.warn('Logout API call failed:', err);
        }
        
        // Clear localStorage and redirect
        localStorage.removeItem('userEmail');
        localStorage.removeItem('trialEnd');
        window.location.href = '/';
      }
      
      // Validate session on page load
      validateSession();
      
      // Validate session every 5 minutes
      setInterval(validateSession, 5 * 60 * 1000);
      
      // Make logout function globally available
      window.logout = logout;
      
      // ==================== END SESSION VALIDATION ====================
      
      document.getElementById('messageInput').focus();
    });

    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        document.getElementById('mobileOverlay').classList.remove('active');
        document.getElementById('sidebar').classList.remove('open');
      }
    });

    // ==================== TTS/VOICE FEATURE ====================

    // TTS State Variables
    let ttsEnabled = localStorage.getItem('ttsEnabled') !== 'false';
    let isCurrentlySpeaking = false;
    let currentAudioPlayback = null;  // Track current audio for Eleven Labs

    // Load TTS settings on page load
    function loadTTSSettings() {
      document.getElementById('ttsEnabled').checked = ttsEnabled;
      updateTTSButton();
      console.log('🎤 TTS: Settings loaded', { ttsEnabled });
    }

    // Toggle TTS on/off
    function toggleTTS() {
      // Handle both checkbox and button click scenarios
      const checkbox = document.getElementById('ttsEnabled');
      const button = document.getElementById('ttsToggleBtn');
      
      // If called from button, toggle the state
      if (!event || event.target.closest('.tts-btn')) {
        ttsEnabled = !ttsEnabled;
        if (checkbox) {
          checkbox.checked = ttsEnabled;
        }
      } else if (checkbox) {
        // If called from checkbox
        ttsEnabled = checkbox.checked;
      }
      
      localStorage.setItem('ttsEnabled', ttsEnabled);
      updateTTSStatus();
      updateTTSButton();
      
      // Stop any currently speaking audio
      if (!ttsEnabled && isCurrentlySpeaking) {
        window.speechSynthesis.cancel();
        isCurrentlySpeaking = false;
        hideTTSActiveIndicator();
      }
    }

    // Update TTS button appearance
    function updateTTSButton() {
      const button = document.getElementById('ttsToggleBtn');
      if (button) {
        if (ttsEnabled) {
          button.classList.add('active');
          button.setAttribute('title', 'Voice Output (TTS) - ON');
        } else {
          button.classList.remove('active');
          button.setAttribute('title', 'Voice Output (TTS) - OFF');
        }
      }
    }

    // Update TTS status display
    function updateTTSStatus() {
      const statusSpan = document.getElementById('ttsStatus');
      if (statusSpan) {
        statusSpan.textContent = ttsEnabled ? 'ON' : 'OFF';
      }
    }

    // Go to checkout with selected plan
    function goToCheckout(plan) {
      const userEmail = localStorage.getItem('userEmail') || '';
      const userPhone = localStorage.getItem('userPhone') || '';
      
      if (!userEmail) {
        alert('Please sign in first to upgrade');
        return;
      }

      // Close settings modal
      closeModal('settingsModal');

      // Redirect to checkout with plan
      const checkoutUrl = `/checkout?email=${encodeURIComponent(userEmail)}&phone=${encodeURIComponent(userPhone)}&plan=${plan}`;
      window.location.href = checkoutUrl;
    }

    // Open checkout with default monthly plan (called from trial badge click)
    function openCheckout() {
      goToCheckout('monthly');
    }

    // Main TTS function - speak message using Eleven Labs
    async function speakMessage(text) {
      if (!ttsEnabled || !text) {
        return;
      }

      try {
        // Stop any currently playing audio
        if (window.currentAudioPlayback) {
          window.currentAudioPlayback.pause();
          window.currentAudioPlayback.currentTime = 0;
          window.currentAudioPlayback = null;
        }

        console.log('🎤 VERA: Requesting TTS for ' + text.length + ' chars');
        showTTSActiveIndicator();
        isCurrentlySpeaking = true;

        // Call /api/tts endpoint (same as chat.html)
        const response = await fetch('/api/tts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: text })
        });
        
        if (response.ok) {
          const audioBlob = await response.blob();
          const audioUrl = URL.createObjectURL(audioBlob);
          const audio = new Audio(audioUrl);
          window.currentAudioPlayback = audio;

          audio.onplay = () => {
            console.log('🎤 VERA speaking...');
            isCurrentlySpeaking = true;
            showTTSActiveIndicator();
          };

          audio.onended = () => {
            console.log('🎤 VERA finished speaking');
            isCurrentlySpeaking = false;
            hideTTSActiveIndicator();
            URL.revokeObjectURL(audioUrl);
            window.currentAudioPlayback = null;
          };

          audio.onerror = () => {
            console.error('🎤 Audio playback error');
            isCurrentlySpeaking = false;
            hideTTSActiveIndicator();
            window.currentAudioPlayback = null;
          };

          console.log('🎤 Playing audio from Eleven Labs');
          audio.play().catch(err => {
            console.error('🎤 Audio play failed:', err.message);
            isCurrentlySpeaking = false;
            hideTTSActiveIndicator();
          });
        } else {
          console.error('🎤 TTS response not ok:', response.status);
          isCurrentlySpeaking = false;
          hideTTSActiveIndicator();
        }
      } catch (error) {
        console.error('🎤 TTS Error:', error.message);
        isCurrentlySpeaking = false;
        hideTTSActiveIndicator();
      }
    }

    // Show TTS active indicator
    function showTTSActiveIndicator() {
      let indicator = document.getElementById('ttsActiveIndicator');

      if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'ttsActiveIndicator';
        indicator.className = 'tts-active-indicator';
        indicator.innerHTML = `
          <span class="speaker-icon">🔊</span>

          <span class="speaking-text">VERA speaking</span>
          <span class="sound-waves">
            <span class="wave"></span>
            <span class="wave"></span>
            <span class="wave"></span>
          </span>
        `;

        // Find nav buttons area and insert
        const navButtons = document.querySelector('.nav-buttons');
        if (navButtons) {
          navButtons.appendChild(indicator);
        }
      }

      indicator.style.display = 'flex';
    }

    // Hide TTS active indicator
    function hideTTSActiveIndicator() {
      const indicator = document.getElementById('ttsActiveIndicator');
      if (indicator) {
        indicator.style.display = 'none';
      }
    }

    // Show TTS discovery notification (first time)
    function showTTSDiscoveryNotification() {
      if (!localStorage.getItem('ttsNotificationShown')) {
        const notification = document.createElement('div');
        notification.className = 'tts-discovery-toast';
        notification.innerHTML = `
          <div class="toast-icon">🎵</div>
          <div class="toast-content">
            <strong>New Feature! Try Audio</strong>
            <p>Hear VERA speak your responses</p>
          </div>
          <button class="toast-btn-dismiss" onclick="dismissTTSNotification()">✕</button>
          <button class="toast-btn-primary" onclick="openSettingsAudio()">Try Now</button>
        `;

        document.body.appendChild(notification);

        // Auto-hide after 5 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
              if (notification.parentNode) {
                notification.remove();
              }
            }, 300);
          }
        }, 5000);

        localStorage.setItem('ttsNotificationShown', true);
      }
    }

    // Dismiss TTS notification
    function dismissTTSNotification() {
      const notification = document.querySelector('.tts-discovery-toast');
      if (notification) {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 300);
      }
    }

    // Open Settings and scroll to Audio & Voice section
    function openSettingsAudio() {
      openSettings();
      setTimeout(() => {
        const audioSection = document.querySelector('.settings-item:last-child');
        if (audioSection) {
          audioSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }, 100);
    }

    // Suggest TTS feature contextually
    function suggestTTSFeature(context) {
      // Disabled - don't show TTS suggestions
      return;
    }

    // Hook into VERA response display
    const originalAddMessage = window.addMessage;
    window.addMessage = function(sender, text, ...args) {
      // Call original function (which already calls speakMessage for VERA messages)
      originalAddMessage.call(this, sender, text, ...args);

      // If VERA just sent a message, show contextual suggestions
      if (sender === 'vera') {
        // Small delay to let message render
        setTimeout(() => {
          // Contextual suggestions
          if (text.length > 500) {
            suggestTTSFeature('long_response');
          }
          if (text.includes('Great work') || text.includes('well done') || text.includes('Excellent')) {
            suggestTTSFeature('checkin_complete');
          }
          if (text.toLowerCase().includes('breath')) {
            suggestTTSFeature('breathing_exercise');
          }
        }, 100);
      }
    };

    // Add slideOut animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    // Initialize TTS on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadTTSSettings();
      showTTSDiscoveryNotification();
      handleMagicLinkActivation();
      initializeTrialBanner();
      handlePaymentReturn();
    });

    // Also run if DOM is already loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        loadTTSSettings();
        showTTSDiscoveryNotification();
        handleMagicLinkActivation();
        initializeTrialBanner();
        handlePaymentReturn();
      });
    } else {
      loadTTSSettings();
      showTTSDiscoveryNotification();
      handleMagicLinkActivation();
      initializeTrialBanner();
      handlePaymentReturn();
    }

    // Handle magic link activation from email
    function handleMagicLinkActivation() {
      const params = new URLSearchParams(window.location.search);
      const email = params.get('email');
      const trial = params.get('trial');
      const trialStart = params.get('trialStart');
      const trialEnd = params.get('trialEnd');
      const subscription_status = params.get('subscription_status');

      if (trial === 'true' && email) {
        console.log('✨ Trial activated via magic link for:', email);

        // Store email in localStorage
        localStorage.setItem('userEmail', email);
        
        // Extract name from email (before @)
        const userName = email.split('@')[0].charAt(0).toUpperCase() + email.split('@')[0].slice(1);
        localStorage.setItem('userName', userName);

        // Store trial data
        localStorage.setItem('trialStartedAt', trialStart || Date.now().toString());
        localStorage.setItem('trialEndsAt', trialEnd || (Date.now() + 48 * 60 * 60 * 1000).toString());
        localStorage.setItem('subscription_status', subscription_status || 'trial');

        // Handle different subscription statuses
        if (subscription_status === 'payment_failed') {
          console.log('⚠️ Payment failed but granting access with grace period');
          showPaymentFailedNotice(`Payment failed for ${userName}. Using VERA with retry option available.`);
        } else if (subscription_status === 'active') {
          showSuccessToast(`🎉 Welcome! Your subscription is active, ${userName}!`);
        } else {
          showSuccessToast(`🎉 Welcome! Your 48-hour trial has been activated, ${userName}!`);
        }

        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    function showPaymentFailedNotice(message) {
      const toast = document.createElement('div');
      toast.className = 'payment-failed-notice';
      toast.innerHTML = `
        <div style="display: flex; gap: 1rem; align-items: center; width: 100%; justify-content: space-between;">
          <div style="display: flex; gap: 1rem; align-items: center; flex: 1;">
            <span style="font-size: 1.5rem;">⚠️</span>
            <div style="flex: 1;">
              <strong>${message}</strong>
              <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; opacity: 0.8;">Your payment method failed. Retry payment to continue after grace period.</p>
            </div>
          </div>
          <button onclick="openCheckout();" style="padding: 0.5rem 1rem; background: #e67e22; border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: 600;">Retry Payment</button>
        </div>
      `;
      toast.style.cssText = `
        position: fixed;
        top: 1rem;
        right: 1rem;
        background: linear-gradient(135deg, rgba(230, 126, 34, 0.15) 0%, rgba(192, 108, 25, 0.15) 100%);
        border: 1px solid rgba(230, 126, 34, 0.6);
        border-radius: 12px;
        padding: 1rem;
        color: white;
        z-index: 10001;
        max-width: 500px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease;
      `;
      document.body.appendChild(toast);

      // Keep visible for 10 seconds, but user can dismiss
      setTimeout(() => {
        if (toast.parentNode) {
          toast.style.animation = 'slideOut 0.3s ease-in';
          setTimeout(() => toast.remove(), 300);
        }
      }, 10000);
    }

    // Handle return from Stripe payment
    function handlePaymentReturn() {
      const params = new URLSearchParams(window.location.search);
      const paymentSuccess = params.get('payment_success');
      const paymentCancelled = params.get('payment_cancelled');
      const sessionId = params.get('session_id');

      if (paymentSuccess === 'true') {
        console.log('✅ Payment successful! Session ID:', sessionId);
        
        // Show success message
        showSuccessToast('Payment successful! Your subscription is now active.');
        
        // Refresh subscription status
        setTimeout(() => {
          initializeTrialBanner();
        }, 1000);

        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
      } else if (paymentCancelled === 'true') {
        console.log('❌ Payment cancelled');
        showErrorToast('Payment was cancelled. You can try again anytime.');
        
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    function showSuccessToast(message) {
      const toast = document.createElement('div');
      toast.className = 'trial-toast';
      toast.style.background = 'linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(56, 142, 60, 0.15) 100%)';
      toast.style.borderColor = 'rgba(76, 175, 80, 0.6)';
      toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
          <span style="font-size: 1.2rem;">✓</span>
          <span style="flex: 1;">${message}</span>
        </div>
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        if (toast.parentNode) {
          toast.style.animation = 'slideOut 0.3s ease-in';
          setTimeout(() => toast.remove(), 300);
        }
      }, 5000);
    }

    function showErrorToast(message) {
      const toast = document.createElement('div');
      toast.className = 'trial-toast';
      toast.style.background = 'linear-gradient(135deg, rgba(244, 67, 54, 0.15) 0%, rgba(211, 47, 47, 0.15) 100%)';
      toast.style.borderColor = 'rgba(244, 67, 54, 0.6)';
      toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
          <span style="font-size: 1.2rem;">⚠</span>
          <span style="flex: 1;">${message}</span>
        </div>
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        if (toast.parentNode) {
          toast.style.animation = 'slideOut 0.3s ease-in';
          setTimeout(() => toast.remove(), 300);
        }
      }, 5000);
    }

    // ===== TRIAL MANAGEMENT =====
    let trialEndTime = null;
    let trialTimerInterval = null;

    async function initializeTrialBanner() {
      try {
        // Get user email from localStorage
        const userEmail = localStorage.getItem('userEmail');
        if (!userEmail) return; // Not logged in

        // Check if trial end time is stored in localStorage (from magic link activation)
        const trialEndsAtStr = localStorage.getItem('trialEndsAt');
        if (trialEndsAtStr) {
          // Trial activated via magic link - use the stored end time
          trialEndTime = new Date(parseInt(trialEndsAtStr));
          console.log('✅ Using trial end time from localStorage:', trialEndTime);
          
          // Show banner
          showTrialBanner();

          // Update timer every minute
          updateTrialTimer();
          trialTimerInterval = setInterval(updateTrialTimer, 60000);
          return;
        }

        // Fetch subscription status for logged-in users (non-magic-link path)
        const response = await fetch(`/api/subscription-status?email=${encodeURIComponent(userEmail)}`);
        const data = await response.json();

        if (data.subscription && data.subscription.isOnTrial) {
          // User is on trial
          trialEndTime = new Date();
          const hoursRemaining = data.subscription.hoursRemaining || 48;
          trialEndTime.setHours(trialEndTime.getHours() + hoursRemaining);

          // Show banner
          showTrialBanner();

          // Update timer every minute
          updateTrialTimer();
          trialTimerInterval = setInterval(updateTrialTimer, 60000);
        }
      } catch (error) {
        console.error('Trial banner init error:', error);
      }
    }

    function updateTrialTimer() {
      if (!trialEndTime) return;

      const now = new Date();
      const diffMs = trialEndTime - now;

      if (diffMs <= 0) {
        // Trial expired
        clearInterval(trialTimerInterval);
        redirectToUpgrade();
        return;
      }

      const hours = Math.floor(diffMs / (1000 * 60 * 60));
      const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
      const timerText = `${hours}h ${minutes.toString().padStart(2, '0')}m`;

      // Update top-right badge
      const badge = document.getElementById('trialBadge');
      const badgeText = document.getElementById('trialBadgeText');
      if (badge && badgeText) {
        badge.style.display = 'flex';
        badgeText.textContent = timerText;
        
        // Change badge color based on time remaining
        if (hours <= 1) {
          badge.style.borderColor = 'rgba(231, 76, 60, 0.6)';
          badge.style.background = 'linear-gradient(135deg, rgba(231, 76, 60, 0.15) 0%, rgba(192, 57, 43, 0.15) 100%)';
          badge.style.color = '#e74c3c';
        } else if (hours <= 6) {
          badge.style.borderColor = 'rgba(230, 126, 34, 0.6)';
          badge.style.background = 'linear-gradient(135deg, rgba(230, 126, 34, 0.15) 0%, rgba(192, 108, 25, 0.15) 100%)';
          badge.style.color = '#e67e22';
        } else if (hours <= 24) {
          badge.style.borderColor = 'rgba(241, 196, 15, 0.6)';
          badge.style.background = 'linear-gradient(135deg, rgba(241, 196, 15, 0.15) 0%, rgba(183, 149, 11, 0.15) 100%)';
          badge.style.color = '#f39c12';
        }
      }

      // Show stronger prompt at 24h and 6h marks
      if (hours === 24 || hours === 6) {
        showTrialUpgradePrompt();
      }
    }

    function showTrialBanner() {
      const banner = document.getElementById('trialBanner');
      if (banner) {
        banner.style.display = 'block';
      }
    }

    function dismissTrialBanner() {
      const banner = document.getElementById('trialBanner');
      if (banner) {
        banner.style.display = 'none';
      }
    }

    function showTrialUpgradePrompt() {
      // Toast notification for upgrade reminder
      const toast = document.createElement('div');
      toast.className = 'tts-discovery-toast';
      toast.innerHTML = `
        <div class="toast-icon">⏰</div>
        <div class="toast-content">
          <strong>Your trial is ending soon</strong>
          <p>Upgrade to continue with VERA</p>
        </div>
        <button class="toast-btn-primary" onclick="openTrialUpgradeModal(); this.parentElement.remove();">Upgrade</button>
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        if (toast.parentNode) {
          toast.style.animation = 'slideOut 0.3s ease-in';
          setTimeout(() => toast.remove(), 300);
        }
      }, 8000);
    }

    // Check trial status and show notification during chat
    function checkAndShowTrialNotification() {
      if (!trialEndTime) return;

      const now = new Date();
      const diffMs = trialEndTime - now;
      const hoursRemaining = diffMs / (1000 * 60 * 60);
      const minutesRemaining = (diffMs / (1000 * 60)) % 60;

      // Show notification if trial is active and less than 12 hours remaining
      if (hoursRemaining > 0 && hoursRemaining < 12) {
        const lastNotification = localStorage.getItem('lastTrialNotificationTime');
        const nowTime = Date.now();
        
        // Show every 2 messages when in final 12 hours
        const messageCount = localStorage.getItem('messageCountSinceTrialNotify') || 0;
        const shouldShow = !lastNotification || 
                          (nowTime - parseInt(lastNotification)) > 5 * 60 * 1000 || 
                          parseInt(messageCount) >= 2;
        
        if (shouldShow) {
          // Format time display
          const hours = Math.floor(hoursRemaining);
          const mins = Math.floor(minutesRemaining);
          const timeStr = `${hours}h ${mins}m`;
          
          // Show compact trial notification
          showCompactTrialNotification(timeStr);
          localStorage.setItem('lastTrialNotificationTime', nowTime.toString());
          localStorage.setItem('messageCountSinceTrialNotify', '0');
        } else {
          const count = parseInt(messageCount) + 1;
          localStorage.setItem('messageCountSinceTrialNotify', count.toString());
        }
      }
    }

    function showCompactTrialNotification(timeRemaining) {
      // Remove any existing trial toasts
      const existing = document.querySelectorAll('.trial-toast');
      existing.forEach(t => t.remove());
      
      const toast = document.createElement('div');
      toast.className = 'trial-toast';
      toast.innerHTML = `
        <div class="trial-toast-content">
          <span class="trial-clock">⏰</span>
          <div class="trial-text">
            <strong>Trial ending in ${timeRemaining}</strong>
            <p>Upgrade to keep using VERA</p>
          </div>
          <button class="trial-toast-btn" onclick="openCheckout();">Upgrade</button>
        </div>
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        if (toast.parentNode) {
          toast.style.animation = 'slideOut 0.3s ease-in';
          setTimeout(() => toast.remove(), 300);
        }
      }, 6000);
    }

    function openTrialUpgradeModal() {
      const modal = document.getElementById('trialUpgradeModal');
      if (modal) {
        modal.style.display = 'flex';

        // Pre-fill email if available
        const userEmail = localStorage.getItem('userEmail');
        if (userEmail) {
          document.getElementById('trialEmail').value = userEmail;
        }
      }
    }

    function closeTrialUpgradeModal() {
      const modal = document.getElementById('trialUpgradeModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    function selectPlan(element, plan) {
      // Deselect all
      document.querySelectorAll('.plan-card').forEach(card => {
        card.classList.remove('selected');
      });
      // Select clicked
      element.classList.add('selected');
      // Store selection
      localStorage.setItem('selectedPlan', plan);
    }

    async function handleTrialProfileSubmit(event) {
      event.preventDefault();

      const email = document.getElementById('trialEmail').value.trim();
      const phone = document.getElementById('trialPhone').value.trim();
      const plan = localStorage.getItem('selectedPlan') || 'monthly';

      if (!email || !phone) {
        alert('Please fill in all fields');
        return;
      }

      try {
        // Check for duplicate phone and update profile
        const response = await fetch('/api/profile-update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, phone_number: phone })
        });

        const result = await response.json();

        if (!response.ok) {
          if (result.code === 'DUPLICATE_PHONE') {
            alert('This phone number is already registered. Please use a different one or log in.');
            return;
          }
          throw new Error(result.error || 'Failed to update profile');
        }

        // Store selection and redirect to checkout
        localStorage.setItem('selectedPlan', plan);
        localStorage.setItem('userEmail', email);

        // Redirect to checkout page with pre-filled data
        const checkoutUrl = `/checkout?email=${encodeURIComponent(email)}&phone=${encodeURIComponent(phone)}&plan=${plan}`;
        window.location.href = checkoutUrl;
      } catch (error) {
        console.error('Profile submission error:', error);
        alert('Error: ' + error.message);
      }
    }

    function redirectToUpgrade() {
      // Trial expired - redirect to upgrade/checkout
      const userEmail = localStorage.getItem('userEmail') || '';
      const userPhone = localStorage.getItem('userPhone') || '';
      const checkoutUrl = `/checkout?email=${encodeURIComponent(userEmail)}&phone=${encodeURIComponent(userPhone)}&expired=true`;
      window.location.href = checkoutUrl;
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(event) {
      const modal = document.getElementById('trialUpgradeModal');
      if (modal && event.target === modal.querySelector('.modal-overlay')) {
        closeTrialUpgradeModal();
      }
    });
  </script>
</body>
</html>
